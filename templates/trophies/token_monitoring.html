{% extends 'base.html' %}
{% block title %}Token Monitoring{% endblock %}
{% block content %}
<div class="container mx-auto p-4 w-full">
    <div class="card bg-base-100 shadow-xl">
        <div class="card-body">
            <h2 class="card-title text-2xl mb-4">TokenKeeper Stats Monitoring</h2>
            <p class="mb-4">Current stats from all machines and instances. Refresh the page to update.</p>
            
            {% if error %}
                <div class="alert alert-error mb-4">
                    {{ error }}
                </div>
            {% elif machines %}
                <div class="space-y-4">
                    {% for machine_id, groups in machines.items %}
                        <div class="collapse collapse-arrow bg-base-200">
                            <input type="checkbox" checked /> 
                            <div class="collapse-title text-lg font-medium">Machine: {{ machine_id }} ({{ groups|length }} Groups)</div>
                            <div class="collapse-content">
                                {% for group_id, group_data in groups.items %}
                                    <div class="mt-4">
                                        <h4 class="text-md font-semibold mb-2">Group: {{ group_id }}</h4>
                                        <div class="overflow-x-auto">
                                            <table class="table w-full table-zebra">
                                                <thead>
                                                    <tr>
                                                        <th>Instance ID</th>
                                                        <th>Outbound IP</th>
                                                        <th>Busy</th>
                                                        <th>Healthy</th>
                                                        <th>Calls in Window</th>
                                                        <th>Access Expiry (s)</th>
                                                        <th>Refresh Expiry (s)</th>
                                                        <th>Token Scopes</th>
                                                        <th>NPSSO Cookie</th>
                                                        <th>Last Error</th>
                                                        <th>Uptime (s)</th>
                                                        <th>Pending Refresh</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% for inst_id, stat in group_data.instances.items %}
                                                        <tr>
                                                            <td>{{ inst_id }}</td>
                                                            <td>{{ stat.outbound_ip }}</td>
                                                            <td>{% if stat.busy %}Yes{% else %}No{% endif %}</td>
                                                            <td>{% if stat.healthy %}Yes{% else %}No{% endif %}</td>
                                                            <td>{{ stat.calls_in_window }}</td>
                                                            <td>{{ stat.access_token_expiry_in|floatformat:0 }}</td>
                                                            <td>{{ stat.refresh_token_expiry_in|floatformat:0 }}</td>
                                                            <td>{{ stat.token_scopes }}</td>
                                                            <td>{{ stat.npsso_cookie }}</td>
                                                            <td>{{ stat.last_error|default:"None" }}</td>
                                                            <td>{{ stat.uptime_seconds|floatformat:0 }}</td>
                                                            <td>{% if stat.pending_refresh %}Yes{% else %}No{% endif %}</td>
                                                        </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="alert alert-info">
                    No stats available.
                </div>
            {% endif %}
            <div class="mt-8">
                <h3 class="text-xl font-bold mb-4">Job Queue Stats</h3>
                {% if queue_stats %}
                    <div class="overflow-x-auto">
                        <table class="table w-full table-zebra">
                            <thead>
                                <tr>
                                    <th>Queue Name</th>
                                    <th>Pending Jobs</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for queue, length in queue_stats.items %}
                                    <tr>
                                        <td>{{ queue }}</td>
                                        <td>{{ length }}</td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="alert alert-info">
                        No queue stats available.
                    </div>
                {% endif %}
            </div>
            <div class="mt-8">
                <h3 class="text-xl font-bold mb-4">Per-Profile Job Queues (Pending Counts)</h3>
                {% if profile_queue_stats %}
                    <div class="overflow-x-auto">
                        <table class="table w-full table-zebra">
                            <thead>
                                <tr>
                                    <th>Profile ID</th>
                                    <th>High Priority</th>
                                    <th>Medium Priority</th>
                                    <th>Low Priority</th>
                                    <th>Total Pending</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for profile_id, queues in profile_queue_stats.items %}
                                    <tr>
                                        <td>{{ profile_id }}</td>
                                        <td>{{ queues.high_priority|default:0 }}</td>
                                        <td>{{ queues.medium_priority|default:0 }}</td>
                                        <td>{{ queues.low_priority|default:0 }}</td>
                                        <td>{{ queues.total }}</td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="alert alert-info">
                        No per-profile job stats available (no pending jobs or error fetching).
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}