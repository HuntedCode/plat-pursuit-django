{% load static humanize %}

{% if community_averages %}
    <div class="card bg-base-100 border-4 border-base-300 shadow-lg shadow-neutral rounded-box m-2">
        <div class="card-body py-2 px-4">
            <h3 class="text-base sm:text-lg md:text-xl lg:text-2xl text-center text-base-content italic mt-1 hover:scale-105">Community Ratings</h3>
            <div class="divider divider-vertical m-0 p-0"></div>
            <div class="grid grid-cols-2 w-full gap-0 mb-2">
                <div class="flex flex-col gap-2 px-2 lg:px-4 pb-2 border-r-2 border-b-2 border-base-content/10 border-dashed">
                    <p class="text-sm text-primary font-bold hover:scale-105">Difficulty</p>
                    <div class="flex flex-row justify-between gap-2 sm:gap-6">
                        <h1 class="text-base lg:text-lg text-base-content font-bold hover:scale-105"><span class="text-xl 2xl:text-3xl text-primary">{{ community_averages.avg_difficulty|floatformat:1 }}</span> /10</h1>
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-7 2xl:w-10 h-7 2xl:h-10 hover:scale-105" viewBox="0 0 24 24" fill="none" stroke="var(--color-primary)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
                    </div>
                    <progress class="progress {% if community_averages.avg_difficulty < 4 %}progress-success{% elif community_averages.avg_difficulty < 8 %}progress-warning{% else %}progress-error{% endif %} hover:scale-105" value="{{ community_averages.avg_difficulty }}" max="10"></progress>
                </div>
                <div class="flex flex-col gap-2 px-2 lg:px-4 pb-2 border-b-2 border-base-content/10 border-dashed">
                    <p class="text-sm text-secondary font-bold hover:scale-105">Hours To Plat</p>
                    <div class="flex flex-row justify-between gap-2 sm:gap-6">
                        <h1 class="text-base lg:text-lg text-base-content font-bold hover:scale-105"><span class="text-xl 2xl:text-3xl text-secondary">{{ community_averages.avg_hours|floatformat:0|intcomma  }}</span></h1>
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-7 2xl:w-10 h-7 2xl:h-10 hover:scale-105" viewBox="0 0 24 24" fill="none" stroke="var(--color-secondary)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
                    </div>
                    <progress class="progress {% if community_averages.avg_hours < 20 %}progress-success{% elif community_averages.avg_hours < 50 %}progress-warning{% elif community_averages.avg_hours < 75 %}progress-accent{% else %}progress-error{% endif %} hover:scale-105" value="{{ community_averages.avg_hours }}" max="100"></progress>
                </div>
                <div class="flex flex-col gap-2 px-2 lg:px-4 pt-2 border-r-2 border-base-content/10 border-dashed">
                    <p class="text-sm text-error font-bold hover:scale-105">Fun Ranking</p>
                    <div class="flex flex-row justify-between gap-2 sm:gap-6">
                        <h1 class="text-base lg:text-lg text-base-content font-bold hover:scale-105"><span class="text-xl 2xl:text-3xl text-error">{{ community_averages.avg_fun|floatformat:1  }}</span> /10</h1>
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-7 2xl:w-10 h-7 2xl:h-10 hover:scale-105" viewBox="0 0 24 24" fill="none" stroke="var(--color-error)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>
                    </div>
                    <progress class="progress {% if community_averages.avg_fun < 4 %}progress-error{% elif community_averages.avg_fun < 8 %}progress-warning{% else %}progress-success{% endif %} hover:scale-105" value="{{ community_averages.avg_fun }}" max="10"></progress>
                </div>
                <div class="flex flex-col gap-2 px-2 lg:px-4 pt-2 border-base-content/10 border-dashed">
                    <p class="text-sm text-warning font-bold hover:scale-105">Overall Rating</p>
                    <div class="flex flex-row justify-between gap-2 sm:gap-6">
                        <h1 class="text-base lg:text-lg text-base-content font-bold hover:scale-105"><span class="text-xl 2xl:text-3xl text-warning">{{ community_averages.avg_rating|floatformat:1  }}</span> /5</h1>
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-7 2xl:w-10 h-7 2xl:h-10 hover:scale-105" viewBox="0 0 24 24" fill="none" stroke="var(--color-warning)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>
                    </div>
                    <progress class="progress {% if community_averages.avg_rating < 1.5 %}progress-error{% elif community_averages.avg_rating < 3.5 %}progress-warning{% else %}progress-success{% endif %} hover:scale-105" value="{{ community_averages.avg_rating }}" max="5"></progress>
                </div>
            </div>
            <p class="text-sm text-base-content text-center italic">Based on {{ community_averages.count|intcomma }} community ratings.</p>
        </div>
    </div>
{% else %}
    <p class="alert alert-info">No community ratings yet. Be the first!</p>
{% endif %}

{% if rating_form %}
    <div class="card bg-base-100 border-4 border-base-300 shadow-lg shadow-neutral rounded-box m-2">
        <div class="card-body py-2 px-4">
            <h3 class="text-base sm:text-lg md:text-xl lg:text-2xl text-center text-base-content italic mt-1 hover:scale-105">Share Your Plat Exerience</h3>
            <div class="divider divider-vertical m-0 p-0"></div>
            <form method="post" class="space-y-6">
                {% csrf_token %}

                <!-- Difficulty (Range Slider) -->
                <div class="form-control">
                    <label class="label" for="{{ form.difficulty.id_for_label }}">
                        <span class="label-text text-base-content">{{ form.difficulty.label }}</span>
                    </label>
                    <input type="range" 
                        name="{{ form.difficulty.name }}" 
                        id="{{ form.difficulty.id_for_label }}" 
                        min="1" max="10" 
                        value="{{ form.difficulty.value|default:5 }}" 
                        class="range range-primary w-full" 
                        step="1" />
                    <div class="w-full flex justify-between text-xs px-2">
                        <span>1</span><span>2</span><span>3</span><span>4</span><span>5</span>
                        <span>6</span><span>7</span><span>8</span><span>9</span><span>10</span>
                    </div>
                    {% if form.difficulty.errors %}
                        <div class="alert alert-error mt-2">{{ form.difficulty.errors }}</div>
                    {% endif %}
                </div>

                <!-- Hours to Platinum (Number Input) -->
                <div class="form-control">
                    <label class="label" for="{{ form.hours_to_platinum.id_for_label }}">
                        <span class="label-text text-base-content">{{ form.hours_to_platinum.label }}</span>
                    </label>
                    <input type="number" 
                        name="{{ form.hours_to_platinum.name }}" 
                        id="{{ form.hours_to_platinum.id_for_label }}" 
                        value="{{ form.hours_to_platinum.value|default:0 }}" 
                        min="0" 
                        class="input input-secondary w-full" 
                        placeholder="e.g., 20" />
                    {% if form.hours_to_platinum.errors %}
                        <div class="alert alert-error mt-2">{{ form.hours_to_platinum.errors }}</div>
                    {% endif %}
                </div>

                <!-- Fun Ranking (Range Slider) -->
                <div class="form-control">
                    <label class="label" for="{{ form.fun_ranking.id_for_label }}">
                        <span class="label-text text-base-content">{{ form.fun_ranking.label }}</span>
                    </label>
                    <input type="range" 
                        name="{{ form.fun_ranking.name }}" 
                        id="{{ form.fun_ranking.id_for_label }}" 
                        min="1" max="10" 
                        value="{{ form.fun_ranking.value|default:5 }}" 
                        class="range range-error w-full" 
                        step="1" />
                    <div class="w-full flex justify-between text-xs px-2">
                        <span>1</span><span>2</span><span>3</span><span>4</span><span>5</span>
                        <span>6</span><span>7</span><span>8</span><span>9</span><span>10</span>
                    </div>
                    {% if form.fun_ranking.errors %}
                        <div class="alert alert-error mt-2">{{ form.fun_ranking.errors }}</div>
                    {% endif %}
                </div>

                <!-- Overall Rating (Range Slider with Stars) -->
                <div class="form-control">
                    <label class="label" for="{{ form.overall_rating.id_for_label }}">
                        <span class="label-text text-base-content">{{ form.overall_rating.label }}</span>
                    </label>
                    <input type="range" 
                        name="{{ form.overall_rating.name }}" 
                        id="{{ form.overall_rating.id_for_label }}" 
                        min="0" max="5.0" 
                        value="{{ form.overall_rating.value|default:3 }}" 
                        class="range range-warning w-full" 
                        step="0.5" />
                    <div class="w-full flex justify-between text-xs">
                        <span>0⭐</span><span>1⭐</span><span>2⭐</span><span>3⭐</span><span>4⭐</span><span>5⭐</span>
                    </div>
                    {% if form.overall_rating.errors %}
                        <div class="alert alert-error mt-2">{{ form.overall_rating.errors }}</div>
                    {% endif %}
                </div>

                <button type="submit" class="btn btn-primary w-full">Submit/Update Rating</button>
            </form>
        </div>
    </div>
{% elif user.is_authenticated %}
    {% if has_platinum == False %}
    <p class="alert alert-warning">Earn the platinum in this game to share your ratings!</p>
    {% endif %}
{% else %}
<p class="alert alert-info">Log in and earn the platinum to rate this game!</p>
{% endif %}