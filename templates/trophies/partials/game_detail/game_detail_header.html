{% load custom_filters humanize static %}
<div class="grid grid-cols-1 xl:grid-cols-3 gap-4">
    <div class="card shadow-lg shadow-neutral bg-base-100 border-2 border-base-300 w-full xl:col-span-1 transition-all duration-300 hover:border-primary hover:shadow-primary">
        <div class="card-body flex flex-col lg:flex-row xl:flex-col items-center justify-between gap-2">
            <div class="flex flex-col gap-2 items-center">
                <div class="hover-3d max-w-3/4 overflow-visible">
                    <figure class="relative h-fit shadow-md shadow-neutral border-2 border-base-300 rounded-box">
                        {% if game.title_image and not game.force_title_icon %}
                            <img src="{{ game.title_image }}" alt="{{ game.title_name }} cover" loading="lazy" decoding="async" class="w-full object-cover" />
                        {% else %}
                            <img src="{{ game.title_icon_url }}" alt="{{ game.title_name }} icon" loading="lazy" decoding="async" class="w-full object-cover" />
                        {% endif %}
                        {% if image_urls.content_rating_url %}
                            <figure class="absolute left-1 bottom-1 w-10 xl:w-8 2xl:w-10">
                                <img src="{{ image_urls.content_rating_url }}" alt="Content rating" loading="lazy" class="w-full object-contain" />
                            </figure>
                        {% endif %}
                    </figure>
                    <div aria-hidden="true"></div>
                    <div aria-hidden="true"></div>
                    <div aria-hidden="true"></div>
                    <div aria-hidden="true"></div>
                    <div aria-hidden="true"></div>
                    <div aria-hidden="true"></div>
                    <div aria-hidden="true"></div>
                    <div aria-hidden="true"></div>
                </div>
                {% if game.concept %}
                    <div class="flex flex-col justify-center items-center gap-2 w-3/4">
                        {% if game.concept.publisher_name %}
                            <p class="text-xs text-base-content line-clamp-1 pr-1">Publisher: <span class="italic">{{ game.concept.publisher_name }}</span></p>
                        {% endif %}
                        {% if game.concept.release_date %}
                            <p class="text-xs text-base-content line-clamp-1 pr-1">Release Date: <time datetime="{{ game.concept.release_date|date:'Y-m-d' }}" class="italic">{{ game.concept.release_date|date }}</time></p>
                        {% endif %}
                    </div>
                {% endif %}
            </div>
            {% if game.concept and image_urls.screenshot_urls %}
                <label for="screenshot-modal" class="max-w-full lg:max-w-1/2 xl:max-w-full flex flex-col items-center cursor-pointer">
                    <div class="carousel w-9/10 max-h-64 xl:max-h-48 border-2 border-base-300 shadow-md shadow-neutral rounded-box hover:scale-105" id="screenshot-carousel" role="region" aria-label="Game screenshots carousel">
                        {% for url in image_urls.screenshot_urls %}
                            <div id="item{{ forloop.counter }}" class="carousel-item w-full" data-src="{{ url }}">
                                <img src="{{ url }}" alt="{{ game.title_name }} screenshot {{ forloop.counter }}" loading="lazy" decoding="async" class="w-full" />
                            </div>
                        {% endfor %}
                    </div>
                    <nav class="flex flex-wrap w-9/10 justify-center gap-2 py-2" aria-label="Screenshot carousel navigation">
                        {% for url in image_urls.screenshot_urls %}
                            <a class="btn btn-xs" data-slide-to="item{{ forloop.counter }}" aria-label="View screenshot {{ forloop.counter }}">{{ forloop.counter }}</a>
                        {% endfor %}
                    </nav>
                </label>
            {% else %}
                {% if profile %}
                    <div class="justify-self-center w-full">
                        <h2 class="text-base lg:text-lg 2xl:text-xl text-base-content text-center font-bold line-clamp-2 pr-1 italic">{{ profile.display_psn_username }}'s Progress</h2>
                        <div class="flex flex-row flex-wrap items-center justify-center gap-x-4 gap-y-1 py-2">
                            <span class="flex items-center gap-1.5">
                                {% include 'partials/icons/trophy_cup.html' with color='var(--color-trophy-bronze)' size='w-5 h-5' %}
                                <span class="text-sm font-bold text-base-content" aria-label="Bronze trophies: {{ profile_trophy_totals.bronze|default:0 }} of {{ game.defined_trophies.bronze }}"><span class="text-primary">{{ profile_trophy_totals.bronze|default:0 }}</span> / {{ game.defined_trophies.bronze }}</span>
                            </span>
                            <span class="text-base-content/30">|</span>
                            <span class="flex items-center gap-1.5">
                                {% include 'partials/icons/trophy_cup.html' with color='var(--color-trophy-silver)' size='w-5 h-5' %}
                                <span class="text-sm font-bold text-base-content" aria-label="Silver trophies: {{ profile_trophy_totals.silver|default:0 }} of {{ game.defined_trophies.silver }}"><span class="text-primary">{{ profile_trophy_totals.silver|default:0 }}</span> / {{ game.defined_trophies.silver }}</span>
                            </span>
                            <span class="text-base-content/30">|</span>
                            <span class="flex items-center gap-1.5">
                                {% include 'partials/icons/trophy_cup.html' with color='var(--color-trophy-gold)' size='w-5 h-5' %}
                                <span class="text-sm font-bold text-base-content" aria-label="Gold trophies: {{ profile_trophy_totals.gold|default:0 }} of {{ game.defined_trophies.gold }}"><span class="text-primary">{{ profile_trophy_totals.gold|default:0 }}</span> / {{ game.defined_trophies.gold }}</span>
                            </span>
                            <span class="text-base-content/30">|</span>
                            <span class="flex items-center gap-1.5">
                                {% include 'partials/icons/trophy_cup.html' with color='var(--color-trophy-platinum)' size='w-5 h-5' %}
                                <span class="text-sm font-bold text-base-content" aria-label="Platinum trophies: {{ profile_trophy_totals.platinum|default:0 }} of {{ game.defined_trophies.platinum }}"><span class="text-primary">{{ profile_trophy_totals.platinum|default:0 }}</span> / {{ game.defined_trophies.platinum }}</span>
                            </span>
                        </div>
                    </div>
                {% else %}
                    <div class="justify-self-center w-full">
                        <h2 class="text-2xl text-base-content text-center font-bold line-clamp-1 pr-1 italic">Total Trophies</h2>
                        <div class="flex flex-row flex-wrap items-center justify-center gap-x-4 gap-y-1 py-2">
                            <span class="flex items-center gap-1.5">
                                {% include 'partials/icons/trophy_cup.html' with color='var(--color-trophy-bronze)' size='w-5 h-5' %}
                                <span class="text-sm font-bold text-base-content">{{ game.defined_trophies.bronze }}</span>
                            </span>
                            <span class="text-base-content/30">|</span>
                            <span class="flex items-center gap-1.5">
                                {% include 'partials/icons/trophy_cup.html' with color='var(--color-trophy-silver)' size='w-5 h-5' %}
                                <span class="text-sm font-bold text-base-content">{{ game.defined_trophies.silver }}</span>
                            </span>
                            <span class="text-base-content/30">|</span>
                            <span class="flex items-center gap-1.5">
                                {% include 'partials/icons/trophy_cup.html' with color='var(--color-trophy-gold)' size='w-5 h-5' %}
                                <span class="text-sm font-bold text-base-content">{{ game.defined_trophies.gold }}</span>
                            </span>
                            <span class="text-base-content/30">|</span>
                            <span class="flex items-center gap-1.5">
                                {% include 'partials/icons/trophy_cup.html' with color='var(--color-trophy-platinum)' size='w-5 h-5' %}
                                <span class="text-sm font-bold text-base-content">{{ game.defined_trophies.platinum }}</span>
                            </span>
                        </div>
                    </div>
                {% endif %}
            {% endif %}
        </div>
    </div>
    <div class="card shadow-lg shadow-neutral bg-base-100 border-2 border-base-300 p-3 w-full h-auto xl:col-span-2 transition-all duration-300 hover:border-secondary hover:shadow-secondary">
        <div class="card-body w-full p-0">
            <div class="flex flex-row items-center justify-between">
                <div class="flex flex-row gap-2 items-center">
                    {% for platform in game.title_platform %}
                        <div class="badge badge-sm md:badge-md lg:badge-lg badge-{{ platform|platform_color_str }} border-2 border-base-300 font-bold hover:scale-105">{{ platform }}</div>
                    {% endfor %}
                    {% if game.is_shovelware %}
                        <div class="tooltip" data-tip="This game has been flagged as shovelware based on its platinum earn rate.">
                            <div class="badge badge-sm md:badge-md lg:badge-lg badge-warning border-2 border-warning/50 font-bold gap-1 hover:scale-105">
                                <svg xmlns="http://www.w3.org/2000/svg" class="w-3 md:w-4 h-3 md:h-4" viewBox="0 0 24 24" fill="currentColor"><path d="m10.06 15.35 7.03-7.03c.98.42 2.16.23 2.95-.57l1.41-1.41c.29-.29.29-.77 0-1.06l-2.74-2.74a.754.754 0 0 0-1.06 0l-1.41 1.41c-.8.8-.98 1.97-.57 2.95l-7.03 7.03-1.77-1.77-3.54 3.54c-1.37 1.37-1.37 3.58 0 4.95s3.58 1.37 4.95 0l3.54-3.54-1.77-1.77Zm7.25-10.34.88-.88 1.68 1.68-.88.88c-.46.46-1.22.46-1.68 0s-.46-1.22 0-1.68M6.88 19.24c-.58.58-1.54.58-2.12 0s-.58-1.54 0-2.12L6.88 15 9 17.12z"/></svg>
                                Shovelware
                            </div>
                        </div>
                    {% endif %}
                </div>
                <h2 class="text-lg md:text-xl lg:text-2xl text-base-content text-center font-bold line-clamp-1 pr-1 italic">{{ game.title_name }}</h2>
                {% if game.is_regional %}
                    <div class="flex flex-row gap-2">
                        {% for region in game.region %}
                            {% if region == "NA" %}
                                <div class="badge badge-sm md:badge-md lg:badge-lg badge-primary font-bold italic hover:scale-105">NA</div>
                            {% elif region == "EU" %}
                                <div class="badge badge-sm md:badge-md lg:badge-lg badge-secondary font-bold italic hover:scale-105">EU</div>
                            {% elif region == "JP" %}
                                <div class="badge badge-sm md:badge-md lg:badge-lg badge-accent font-bold italic hover:scale-105">JP</div>
                            {% else %}
                                <div class="badge badge-sm md:badge-md lg:badge-lg badge-warning font-bold italic hover:scale-105">AS</div>
                            {% endif %}
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="badge badge-sm md:badge-md lg:badge-lg badge-ghost font-bold italic hover:scale-105">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-4 md:w-5 h-4 md:h-5" viewBox="0 0 512 512" stroke="var(--color-success)" fill="var(--color-success)"><path d="M351.9 280l-190.9 0c2.9 64.5 17.2 123.9 37.5 167.4 11.4 24.5 23.7 41.8 35.1 52.4 11.2 10.5 18.9 12.2 22.9 12.2s11.7-1.7 22.9-12.2c11.4-10.6 23.7-28 35.1-52.4 20.3-43.5 34.6-102.9 37.5-167.4zM160.9 232l190.9 0C349 167.5 334.7 108.1 314.4 64.6 303 40.2 290.7 22.8 279.3 12.2 268.1 1.7 260.4 0 256.4 0s-11.7 1.7-22.9 12.2c-11.4 10.6-23.7 28-35.1 52.4-20.3 43.5-34.6 102.9-37.5 167.4zm-48 0C116.4 146.4 138.5 66.9 170.8 14.7 78.7 47.3 10.9 131.2 1.5 232l111.4 0zM1.5 280c9.4 100.8 77.2 184.7 169.3 217.3-32.3-52.2-54.4-131.7-57.9-217.3L1.5 280zm398.4 0c-3.5 85.6-25.6 165.1-57.9 217.3 92.1-32.7 159.9-116.5 169.3-217.3l-111.4 0zm111.4-48C501.9 131.2 434.1 47.3 342 14.7 374.3 66.9 396.4 146.4 399.9 232l111.4 0z"/></svg>
                    </div>
                {% endif %}
            </div>
            {% if profile %}
                <div class="flex flex-row items-center gap-3 py-1">
                    <a href="{% url 'profile_detail' profile.psn_username %}" class="flex flex-row items-center gap-3 hover:scale-105 transition-all">
                        <div class="avatar">
                            <div class="w-12 rounded-full ring-2 ring-primary">
                                <img class="bg-secondary/50" src="{{ profile.avatar_url }}" alt="{{ profile.display_psn_username }}'s avatar" />
                            </div>
                        </div>
                        <div class="flex flex-col">
                            <div class="flex flex-row items-end gap-1">
                                <span class="text-base font-bold text-base-content line-clamp-1">{{ profile.display_psn_username }}</span>
                                {% if profile.is_plus %}
                                    <img src="{% static 'images/plus.png' %}" class="w-5 h-5" alt="Plus member" />
                                {% endif %}
                            </div>
                            <span class="text-xs text-base-content/70 italic pr-1 line-clamp-1">{{ profile.about_me }}</span>
                        </div>
                    </a>
                    {% if game.concept and image_urls.screenshot_urls %}
                        <div class="flex flex-row flex-wrap items-center justify-end gap-x-3 gap-y-1 ml-auto">
                            <span class="flex items-center gap-1.5">
                                {% include 'partials/icons/trophy_cup.html' with color='var(--color-trophy-bronze)' size='w-4.5 h-4.5' %}
                                <span class="text-xs font-bold text-base-content" aria-label="Bronze trophies: {{ profile_trophy_totals.bronze|default:0 }} of {{ game.defined_trophies.bronze }}"><span class="text-primary">{{ profile_trophy_totals.bronze|default:0 }}</span>/{{ game.defined_trophies.bronze }}</span>
                            </span>
                            <span class="text-base-content/30">|</span>
                            <span class="flex items-center gap-1.5">
                                {% include 'partials/icons/trophy_cup.html' with color='var(--color-trophy-silver)' size='w-4.5 h-4.5' %}
                                <span class="text-xs font-bold text-base-content" aria-label="Silver trophies: {{ profile_trophy_totals.silver|default:0 }} of {{ game.defined_trophies.silver }}"><span class="text-primary">{{ profile_trophy_totals.silver|default:0 }}</span>/{{ game.defined_trophies.silver }}</span>
                            </span>
                            <span class="text-base-content/30">|</span>
                            <span class="flex items-center gap-1.5">
                                {% include 'partials/icons/trophy_cup.html' with color='var(--color-trophy-gold)' size='w-4.5 h-4.5' %}
                                <span class="text-xs font-bold text-base-content" aria-label="Gold trophies: {{ profile_trophy_totals.gold|default:0 }} of {{ game.defined_trophies.gold }}"><span class="text-primary">{{ profile_trophy_totals.gold|default:0 }}</span>/{{ game.defined_trophies.gold }}</span>
                            </span>
                            <span class="text-base-content/30">|</span>
                            <span class="flex items-center gap-1.5">
                                {% include 'partials/icons/trophy_cup.html' with color='var(--color-trophy-platinum)' size='w-4.5 h-4.5' %}
                                <span class="text-xs font-bold text-base-content" aria-label="Platinum trophies: {{ profile_trophy_totals.platinum|default:0 }} of {{ game.defined_trophies.platinum }}"><span class="text-primary">{{ profile_trophy_totals.platinum|default:0 }}</span>/{{ game.defined_trophies.platinum }}</span>
                            </span>
                        </div>
                    {% else %}
                        <div class="text-sm text-base-content font-bold ml-auto">{{ profile.country_code }}</div>
                    {% endif %}
                </div>
            {% endif %}
            <div class="divider divider-vertical my-0"></div>
            <div class="flex flex-col lg:flex-row gap-4">
                {% if other_versions or badges %}
                <div class="flex flex-row lg:flex-col gap-4 lg:w-48 xl:w-56 flex-shrink-0">
                    {% if other_versions %}
                    <div class="card border-2 border-base-300 shadow-sm shadow-neutral hover:scale-105 hover:border-error hover:shadow-error group cursor-pointer flex-1 lg:flex-initial"
                         onclick="document.getElementById('versions-modal').showModal()" role="button" aria-label="View all versions">
                        <div class="card-body p-2">
                            <div class="stats stat-compact">
                                <div class="stat">
                                    <div class="stat-figure">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 lg:w-8 lg:h-8 hover:scale-105" viewBox="0 0 24 24" fill="none" stroke="var(--color-base-content)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 2 7 12 12 22 7 12 2"></polygon><polyline points="2 17 12 22 22 17"></polyline><polyline points="2 12 12 17 22 12"></polyline></svg>
                                    </div>
                                    <div class="stat-title text-xs lg:text-sm 2xl:text-base text-base-content/70 italic">Versions</div>
                                    <div class="stat-value text-base lg:text-xl">{{ other_versions|length }}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    {% if badges %}
                        <div class="card border-2 border-base-300 shadow-sm shadow-neutral hover:scale-105 hover:border-error hover:shadow-error group cursor-pointer flex-1 lg:flex-initial"
                                onclick="document.getElementById('badges-modal').showModal()" role="button" aria-label="View all badges">
                            <div class="card-body p-2">
                                <div class="stats stat-compact">
                                    <div class="stat">
                                        <div class="stat-figure">
                                            <figure class="w-8 h-8" aria-hidden="true">
                                                {% include 'partials/badge.html' with layers=badges.0.get_badge_layers %}
                                            </figure>
                                        </div>
                                        <div class="stat-title text-xs lg:text-sm 2xl:text-base text-base-content/70 italic">Badges</div>
                                        <div class="stat-value text-base lg:text-xl">{{ badges|length }}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endif %}
                </div>
                {% endif %}
                <div class="flex-1 min-w-0">
                <div class="grid grid-cols-2 md:grid-cols-3 gap-y-3 gap-x-2">

                    <div class="card border-2 border-base-300 shadow-sm shadow-neutral hover:scale-105 hover:border-secondary hover:shadow-secondary group cursor-pointer"
                         role="button" aria-label="View all players" onclick="window.GamePlayersModal && window.GamePlayersModal.open('total')">
                        <div class="card-body p-2">
                            <div class="stats stat-compact">
                                <div class="stat">
                                    <div class="stat-figure">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 lg:w-8 lg:h-8 hover:scale-105" viewBox="0 0 24 24" fill="none" stroke="var(--color-secondary)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                                    </div>
                                    <div class="stat-title text-xs lg:text-sm 2xl:text-base text-base-content/70 italic">Total Players</div>
                                    <div class="stat-value text-base lg:text-xl">{{ game_stats.total_players|intcomma }}</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card border-2 border-base-300 shadow-sm shadow-neutral hover:scale-105 hover:border-accent hover:shadow-accent group cursor-pointer"
                         role="button" aria-label="View monthly players" onclick="window.GamePlayersModal && window.GamePlayersModal.open('monthly')">
                        <div class="card-body p-2">
                            <div class="stats stat-compact">
                                <div class="stat">
                                    <div class="stat-figure">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 lg:w-8 lg:h-8 hover:scale-105" viewBox="0 0 24 24" fill="none" stroke="var(--color-accent)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
                                    </div>
                                    <div class="stat-title text-xs lg:text-sm 2xl:text-base text-base-content/70 italic">Monthly Players</div>
                                    <div class="stat-value text-base lg:text-xl">{{ game_stats.monthly_players|intcomma }}</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card border-2 border-base-300 shadow-sm shadow-neutral hover:scale-105 hover:border-warning hover:shadow-warning group cursor-pointer"
                         role="button" aria-label="View players by trophies earned" onclick="window.GamePlayersModal && window.GamePlayersModal.open('trophies')">
                        <div class="card-body p-2">
                            <div class="stats stat-compact">
                                <div class="stat">
                                    <div class="stat-figure">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 lg:w-8 lg:h-8 hover:scale-105" viewBox="0 0 24 24" fill="none" stroke="var(--color-warning)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
                                    </div>
                                    <div class="stat-title text-xs lg:text-sm 2xl:text-base text-base-content/70 italic">Trophies Earned</div>
                                    <div class="stat-value text-base lg:text-xl">{{ game_stats.total_earns|intcomma }}</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card border-2 border-base-300 shadow-sm shadow-neutral hover:scale-105 hover:border-primary hover:shadow-primary group cursor-pointer"
                         role="button" aria-label="View platinum earners" onclick="window.GamePlayersModal && window.GamePlayersModal.open('plats')">
                        <div class="card-body p-2">
                            <div class="stats stat-compact">
                                <div class="stat">
                                    <div class="stat-figure">
                                        {% include 'partials/icons/trophy_cup.html' with color='var(--color-primary)' size='w-6 h-6 lg:w-8 lg:h-8' extra_class='hover:scale-105' %}
                                    </div>
                                    <div class="stat-title text-xs lg:text-sm 2xl:text-base text-base-content/70 italic">Plats Earned</div>
                                    <div class="stat-value text-base lg:text-xl">{{ game_stats.plats_earned|intcomma }}</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card border-2 border-base-300 shadow-sm shadow-neutral hover:scale-105 hover:border-info hover:shadow-info group cursor-pointer"
                         role="button" aria-label="View 100% completionists" onclick="window.GamePlayersModal && window.GamePlayersModal.open('completes')">
                        <div class="card-body p-2">
                            <div class="stats stat-compact">
                                <div class="stat">
                                    <div class="stat-figure">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 lg:w-8 lg:h-8 hover:scale-105" viewBox="0 0 24 24" fill="none" stroke="var(--color-info)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 11 12 14 22 4"></polyline><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path></svg>
                                    </div>
                                    <div class="stat-title text-xs lg:text-sm 2xl:text-base text-base-content/70 italic">100% Earns</div>
                                    <div class="stat-value text-base lg:text-xl">{{ game_stats.completes|intcomma }}</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card border-2 border-base-300 shadow-sm shadow-neutral hover:scale-105 hover:border-success hover:shadow-success group cursor-pointer"
                         role="button" aria-label="View players by completion" onclick="window.GamePlayersModal && window.GamePlayersModal.open('avg')">
                        <div class="card-body p-2">
                            <div class="stats stat-compact">
                                <div class="stat">
                                    <div class="stat-figure">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 lg:w-8 lg:h-8 hover:scale-105" viewBox="0 0 24 24" fill="none" stroke="var(--color-success)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3v18h18"/><path d="M18.7 8l-5.1 5.2-2.8-2.7L7 14.3"/></svg>
                                    </div>
                                    <div class="stat-title text-xs lg:text-sm 2xl:text-base text-base-content/70 italic">Avg. Completion</div>
                                    <div class="stat-value text-base lg:text-xl">{{ game_stats.avg_progress|floatformat:2 }}%</div>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
                </div> {# end flex-1 stats wrapper #}
            </div> {# end flex row wrapper #}
                {% if profile and game.concept and image_urls.screenshot_urls %}
                    <div class="grid grid-cols-2 lg:grid-cols-4 gap-2 mt-2">
                        <div class="card border-2 border-base-300 shadow-sm shadow-neutral p-0 hover:scale-105 hover:border-secondary hover:shadow-secondary group">
                            <div class="card-body p-0">
                                <div class="stats stat-compact">
                                    <div class="stat place-items-center p-2">
                                        <div class="stat-value text-base lg:text-xl">{{ profile_progress.progress|floatformat:2|default:0 }}%</div>
                                        <div class="stat-desc italic">Total Completion (PSN)</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="card border-2 border-base-300 shadow-sm shadow-neutral p-0 hover:scale-105 hover:border-secondary hover:shadow-secondary group">
                            <div class="card-body p-0">
                                <div class="stats stat-compact">
                                    <div class="stat place-items-center p-2">
                                        <div class="stat-value text-base lg:text-xl">{{ profile_progress.play_count|intcomma|default:0 }}</div>
                                        <div class="stat-desc italic">Play Count</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="card border-2 border-base-300 shadow-sm shadow-neutral p-0 hover:scale-105 hover:border-secondary hover:shadow-secondary group">
                            <div class="card-body p-0">
                                <div class="stats stat-compact">
                                    <div class="stat place-items-center p-2">
                                        <div class="stat-value text-lg">{{ profile_progress.play_duration|timedelta_hours|default:'-' }}</div>
                                        <div class="stat-desc italic">Play Duration</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="card border-2 border-base-300 shadow-sm shadow-neutral p-0 hover:scale-105 hover:border-secondary hover:shadow-secondary group">
                            <div class="card-body p-0">
                                <div class="stats stat-compact">
                                    <div class="stat place-items-center p-2">
                                        <div class="stat-value text-lg">{{ profile_progress.last_played|date:"F j, Y"|default:'-' }}</div>
                                        <div class="stat-desc italic">Last Played</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                {% else %}
                    <div class="justify-self-center w-full">
                        <div class="flex flex-row flex-wrap items-center justify-center gap-x-4 gap-y-1 py-2 mt-2">
                            <span class="flex items-center gap-1.5">
                                {% include 'partials/icons/trophy_cup.html' with color='var(--color-trophy-bronze)' size='w-5 h-5' %}
                                <span class="text-sm font-bold text-base-content">{{ game.defined_trophies.bronze }}</span>
                            </span>
                            <span class="text-base-content/30">|</span>
                            <span class="flex items-center gap-1.5">
                                {% include 'partials/icons/trophy_cup.html' with color='var(--color-trophy-silver)' size='w-5 h-5' %}
                                <span class="text-sm font-bold text-base-content">{{ game.defined_trophies.silver }}</span>
                            </span>
                            <span class="text-base-content/30">|</span>
                            <span class="flex items-center gap-1.5">
                                {% include 'partials/icons/trophy_cup.html' with color='var(--color-trophy-gold)' size='w-5 h-5' %}
                                <span class="text-sm font-bold text-base-content">{{ game.defined_trophies.gold }}</span>
                            </span>
                            <span class="text-base-content/30">|</span>
                            <span class="flex items-center gap-1.5">
                                {% include 'partials/icons/trophy_cup.html' with color='var(--color-trophy-platinum)' size='w-5 h-5' %}
                                <span class="text-sm font-bold text-base-content">{{ game.defined_trophies.platinum }}</span>
                            </span>
                        </div>
                    </div>
                {% endif %}
            {% if profile %}
                <div class="divider divider-vertical my-1 mb-0"></div>
                <p class="text-sm font-bold text-base-content/70 text-center italic mb-0">
                    {% if game.defined_trophies.platinum %}Platinum Timeline{% else %}Trophy Timeline{% endif %}
                </p>
                <div class="overflow-x-auto w-full py-1 flex justify-center">
                    <ul class="timeline timeline-horizontal">
                        {% for event in timeline_events %}
                            <li>
                                {% if not forloop.first %}
                                    <hr class="{% if event.earned %}bg-primary{% endif %}" />
                                {% endif %}

                                <div class="timeline-start text-center px-1">
                                    <span class="text-xs font-bold {% if event.earned %}text-base-content{% else %}text-base-content/40{% endif %} italic">{{ event.label }}</span>
                                </div>

                                <div class="timeline-middle">
                                    {% if event.event_type == 'started' %}
                                        {% if event.earned %}
                                            <div class="w-8 h-8 rounded-full bg-primary flex items-center justify-center shadow-sm shadow-primary">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-primary-content" viewBox="0 0 24 24" fill="currentColor" stroke="none"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>
                                            </div>
                                        {% else %}
                                            <div class="w-8 h-8 rounded-full border-2 border-base-300 bg-base-200 flex items-center justify-center">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-base-content/30" viewBox="0 0 24 24" fill="currentColor" stroke="none"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>
                                            </div>
                                        {% endif %}
                                    {% elif event.earned and event.trophy_icon_url %}
                                        <a href="#{{ event.trophy_id }}" class="block timeline-trophy-hover"
                                           data-trophy-icon="{{ event.trophy_icon_url }}"
                                           data-trophy-name="{{ event.trophy_name }}"
                                           data-trophy-detail="{{ event.trophy_detail|default_if_none:'' }}"
                                           data-trophy-earn-rate="{{ event.trophy_earn_rate }}">
                                            <figure class="w-10 h-10 rounded-full border-2 border-primary shadow-sm shadow-primary overflow-hidden hover:scale-110 transition-transform">
                                                <img src="{{ event.trophy_icon_url }}" alt="{{ event.trophy_name }}" class="w-full h-full object-cover" loading="lazy" />
                                            </figure>
                                        </a>
                                    {% else %}
                                        {% if not profile.sync_status == 'syncing' %}
                                            <div class="w-10 h-10 rounded-full border-2 border-base-300 bg-base-200 flex items-center justify-center">
                                                {% include 'partials/icons/trophy_cup.html' with color='var(--color-base-content)' size='w-5 h-5' extra_class='opacity-20' %}
                                            </div>
                                        {% else %}
                                            <div class="w-10 h-10 rounded-full border-2 border-base-300 bg-base-200 flex items-center justify-center">
                                                <span class="loading loading-infinity loading-sm"></span>
                                            </div>
                                        {% endif %}
                                    {% endif %}
                                </div>

                                <div class="timeline-end text-center px-1 max-w-28">
                                    {% if event.earned %}
                                        {% if event.event_type == 'trophy' %}
                                            <p class="text-xs text-base-content font-semibold line-clamp-1">{{ event.trophy_name }}</p>
                                            <p class="text-xs text-base-content/70">{{ event.trophy_earn_rate }}%</p>
                                        {% endif %}
                                        {% if event.date %}
                                            <p class="text-xs text-base-content/50 italic">{{ event.date|format_date:"format_short" }}</p>
                                        {% endif %}
                                    {% else %}
                                        <p class="text-xs text-base-content/30 italic">Not yet</p>
                                    {% endif %}
                                </div>

                                {% if not forloop.last %}
                                    <hr class="{% if event.earned %}bg-primary{% endif %}" />
                                {% endif %}
                            </li>
                        {% endfor %}
                    </ul>
                </div>

                {# Shared popover for timeline trophy hover: lives outside overflow container #}
                <div id="timeline-popover" class="fixed w-64 bg-base-200 border border-base-300 rounded-lg shadow-xl p-3 z-50 pointer-events-none opacity-0 invisible transition-all duration-200">
                    <div class="flex gap-3 items-start">
                        <img id="timeline-popover-img" src="" alt="" class="w-16 h-16 rounded-lg object-cover flex-shrink-0" />
                        <div class="min-w-0">
                            <p id="timeline-popover-name" class="font-bold text-sm text-base-content line-clamp-2"></p>
                            <p id="timeline-popover-detail" class="text-xs text-base-content/70 mt-0.5 line-clamp-2"></p>
                            <p id="timeline-popover-rate" class="text-xs text-base-content/50 mt-1"></p>
                        </div>
                    </div>
                    <div class="absolute top-full left-1/2 -translate-x-1/2 w-0 h-0 border-l-8 border-r-8 border-t-8 border-l-transparent border-r-transparent border-t-base-200"></div>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<input type="checkbox" id="screenshot-modal" class="modal-toggle" />
<div class="modal backdrop-blur-lg">
    <div class="modal-box border-4 border-base-300 shadow-lg shadow-neutral w-11/12 max-w-5xl h-fit">
        <figure class="w-full">
            <img id="modal-image" src="{{ image_urls.screenshot_urls.0 }}" class="w-full object-cover" />
        </figure>
    </div>
    <label class="modal-backdrop" for="screenshot-modal">Close</label>
</div>

{% if other_versions %}
<dialog id="versions-modal" class="modal">
    <div class="modal-box max-w-lg bg-base-200 border-2 border-base-300">
        <form method="dialog">
            <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2" aria-label="Close">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
            </button>
        </form>
        <h3 class="font-bold text-lg mb-4">Additional Versions</h3>
        <div class="flex flex-col gap-2 max-h-[60vh] overflow-y-auto">
            {% for version in other_versions %}
                <a href="{% if url_psn_username %}{% url 'game_detail_with_profile' version.np_communication_id url_psn_username %}{% else %}{% url 'game_detail' version.np_communication_id %}{% endif %}"
                   class="card card-compact bg-base-100 border border-base-300 p-3 hover:border-primary hover:shadow-sm transition-all" aria-label="View {{ version.title_name }}">
                    <div class="flex flex-row gap-3 items-center">
                        <figure class="w-10 h-10 flex-shrink-0 rounded overflow-hidden border border-base-300">
                            <img src="{{ version.title_icon_url }}" alt="{{ version.title_name }} icon" loading="lazy" decoding="async" class="w-full h-full object-cover" />
                        </figure>
                        <div class="min-w-0">
                            <div class="flex flex-row flex-wrap gap-1.5 items-center">
                                {% for platform in version.title_platform %}
                                    <div class="badge badge-sm badge-{{ platform|platform_color_str }} border border-base-300 font-bold">{{ platform }}</div>
                                {% endfor %}
                                {% if version.is_regional %}
                                    {% for region in version.region %}
                                        {% if region == "NA" %}
                                            <div class="badge badge-sm badge-primary font-bold italic">NA</div>
                                        {% elif region == "EU" %}
                                            <div class="badge badge-sm badge-secondary font-bold italic">EU</div>
                                        {% elif region == "JP" %}
                                            <div class="badge badge-sm badge-accent font-bold italic">JP</div>
                                        {% else %}
                                            <div class="badge badge-sm badge-warning font-bold italic">AS</div>
                                        {% endif %}
                                    {% endfor %}
                                {% else %}
                                    <div class="badge badge-sm badge-ghost font-bold italic">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="w-3.5 h-3.5" viewBox="0 0 512 512" stroke="var(--color-success)" fill="var(--color-success)"><path d="M351.9 280l-190.9 0c2.9 64.5 17.2 123.9 37.5 167.4 11.4 24.5 23.7 41.8 35.1 52.4 11.2 10.5 18.9 12.2 22.9 12.2s11.7-1.7 22.9-12.2c11.4-10.6 23.7-28 35.1-52.4 20.3-43.5 34.6-102.9 37.5-167.4zM160.9 232l190.9 0C349 167.5 334.7 108.1 314.4 64.6 303 40.2 290.7 22.8 279.3 12.2 268.1 1.7 260.4 0 256.4 0s-11.7 1.7-22.9 12.2c-11.4 10.6-23.7 28-35.1 52.4-20.3 43.5-34.6 102.9-37.5 167.4zm-48 0C116.4 146.4 138.5 66.9 170.8 14.7 78.7 47.3 10.9 131.2 1.5 232l111.4 0zM1.5 280c9.4 100.8 77.2 184.7 169.3 217.3-32.3-52.2-54.4-131.7-57.9-217.3L1.5 280zm398.4 0c-3.5 85.6-25.6 165.1-57.9 217.3 92.1-32.7 159.9-116.5 169.3-217.3l-111.4 0zm111.4-48C501.9 131.2 434.1 47.3 342 14.7 374.3 66.9 396.4 146.4 399.9 232l111.4 0z"/></svg>
                                    </div>
                                {% endif %}
                            </div>
                            <p class="text-sm text-base-content font-medium mt-1 line-clamp-1">{{ version.title_name }}</p>
                        </div>
                    </div>
                </a>
            {% endfor %}
        </div>
        <div class="modal-action">
            <form method="dialog">
                <button class="btn btn-ghost">Close</button>
            </form>
        </div>
    </div>
    <form method="dialog" class="modal-backdrop"><button>close</button></form>
</dialog>
{% endif %}

{% if badges %}
<dialog id="badges-modal" class="modal">
    <div class="modal-box max-w-md bg-base-200 border-2 border-base-300">
        <form method="dialog">
            <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2" aria-label="Close">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
            </button>
        </form>
        <h3 class="font-bold text-lg mb-4">Badges</h3>
        <div class="flex flex-col gap-2 max-h-[60vh] overflow-y-auto">
            {% for badge in badges %}
                <a href="{% if profile %}{% url 'badge_detail_with_profile' badge.series_slug profile.psn_username %}{% else %}{% url 'badge_detail' badge.series_slug %}{% endif %}"
                   class="card card-compact bg-base-100 border border-base-300 p-3 hover:border-error hover:shadow-sm transition-all" aria-label="View {{ badge.display_series }} badge">
                    <div class="flex flex-row gap-3 items-center">
                        <figure class="w-10 h-10 flex-shrink-0" aria-hidden="true">
                            {% include 'partials/badge.html' with layers=badge.get_badge_layers %}
                        </figure>
                        <span class="text-sm text-base-content font-medium">{{ badge.display_series }}</span>
                    </div>
                </a>
            {% endfor %}
        </div>
        <div class="modal-action">
            <form method="dialog">
                <button class="btn btn-ghost">Close</button>
            </form>
        </div>
    </div>
    <form method="dialog" class="modal-backdrop"><button>close</button></form>
</dialog>
{% endif %}

{% include 'trophies/partials/game_detail/game_players_modal.html' %}

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const carousel = document.getElementById('screenshot-carousel');
        const modalImage = document.getElementById('modal-image');

        if (carousel && modalImage) {
            carousel.addEventListener('click', function(e) {
                const item = e.target.closest('.carousel-item');
                if (item) {
                    const src = item.dataset.src;
                    modalImage.src = src;
                }
            });
        }

        // Timeline trophy hover popover
        const popover = document.getElementById('timeline-popover');
        if (popover) {
            const popoverImg = document.getElementById('timeline-popover-img');
            const popoverName = document.getElementById('timeline-popover-name');
            const popoverDetail = document.getElementById('timeline-popover-detail');
            const popoverRate = document.getElementById('timeline-popover-rate');

            document.querySelectorAll('.timeline-trophy-hover').forEach(function(trigger) {
                trigger.addEventListener('mouseenter', function() {
                    popoverImg.src = trigger.dataset.trophyIcon;
                    popoverImg.alt = trigger.dataset.trophyName;
                    popoverName.textContent = trigger.dataset.trophyName;
                    const detail = trigger.dataset.trophyDetail;
                    popoverDetail.textContent = detail;
                    popoverDetail.classList.toggle('hidden', !detail);
                    popoverRate.textContent = trigger.dataset.trophyEarnRate + '% earn rate';

                    const rect = trigger.getBoundingClientRect();
                    const popoverWidth = 256;
                    let left = rect.left + rect.width / 2 - popoverWidth / 2;
                    left = Math.max(8, Math.min(left, window.innerWidth - popoverWidth - 8));
                    popover.style.left = left + 'px';
                    popover.style.top = (rect.top - 8) + 'px';
                    popover.style.transform = 'translateY(-100%)';

                    popover.classList.remove('opacity-0', 'invisible');
                    popover.classList.add('opacity-100', 'visible');
                });

                trigger.addEventListener('mouseleave', function() {
                    popover.classList.remove('opacity-100', 'visible');
                    popover.classList.add('opacity-0', 'invisible');
                });
            });
        }
    })
</script>
