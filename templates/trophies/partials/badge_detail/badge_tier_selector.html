{% load static custom_filters humanize %}

<div id="tier-selector" class="scroll-mt-4">
    <!-- Tier Tabs -->
    <div class="flex flex-row justify-center gap-2 lg:gap-3 mb-4">
        {% for tb in all_tier_badges %}
            <a href="?tier={{ tb.tier }}"
               class="flex flex-row items-center gap-1.5 px-3 py-2 rounded-box border-2 font-bold italic text-xs lg:text-sm transition-all duration-300 {% if tb.tier == selected_tier %}border-{{ tb.tier|badge_color }} bg-{{ tb.tier|badge_color }}/10 shadow-md shadow-{{ tb.tier|badge_color }} text-{{ tb.tier|badge_color }}{% else %}border-base-300 bg-base-100 text-base-content/70 hover:border-{{ tb.tier|badge_color }} hover:text-{{ tb.tier|badge_color }}{% endif %}"
               data-tier-tab>
                <figure class="w-5 h-5 lg:w-6 lg:h-6">
                    {% with tb.tier|stringformat:'s' as tier_str %}
                        <img src="{% static 'images/badges/backdrops/'|add:tier_str|add:'_backdrop.png' %}" alt="{{ tb.tier|badge_tier }}" class="w-full object-contain" loading="lazy" decoding="async" />
                    {% endwith %}
                </figure>
                <span class="hidden lg:inline">{{ tb.tier|badge_tier }}</span>
            </a>
        {% endfor %}
    </div>

    <!-- Tier Requirements Panel -->
    {% if selected_tier_badge %}
        <div class="card bg-base-100 border-4 border-{{ selected_tier|badge_color }}/50 shadow-lg shadow-neutral">
            <div class="card-body p-3 lg:p-4">
                <!-- Header: requirement type + XP reward -->
                <div class="flex flex-row items-center justify-between mb-3">
                    <div class="flex flex-row items-center gap-2">
                        {% if badge.badge_type == 'megamix' %}
                            <span class="text-sm lg:text-base font-bold italic text-base-content">Earn</span>
                            <img src="{% static 'images/plat.png' %}" class="w-5 h-5 lg:w-6 lg:h-6" alt="Platinum" loading="lazy" decoding="async" />
                            <span class="text-lg lg:text-xl font-bold text-{{ selected_tier|badge_color }}">{{ selected_tier_requirements }}</span>
                            <span class="text-sm lg:text-base font-bold italic text-base-content">platinums in:</span>
                        {% elif selected_tier_is_plat %}
                            <img src="{% static 'images/plat.png' %}" class="w-5 h-5 lg:w-6 lg:h-6" alt="Platinum" loading="lazy" decoding="async" />
                            <span class="text-sm lg:text-base font-bold italic text-base-content">Earn Platinum in all stages:</span>
                        {% else %}
                            <span class="text-sm lg:text-base font-bold italic text-warning">100%</span>
                            <span class="text-sm lg:text-base font-bold italic text-base-content">Earn 100% in all stages:</span>
                        {% endif %}
                    </div>
                    <div class="flex flex-col items-end gap-0.5">
                        {% if target_profile %}
                            <span class="text-base lg:text-lg font-bold text-{{ selected_tier|badge_color }}">{{ selected_tier_user_xp|intcomma }} / {{ selected_tier_total_xp|intcomma }} XP</span>
                        {% else %}
                            <span class="text-base lg:text-lg font-bold text-{{ selected_tier|badge_color }}">{{ selected_tier_total_xp|intcomma }} XP</span>
                        {% endif %}
                        <span class="text-xs text-base-content/50 italic">{{ badge_tier_xp_bonus|intcomma }} bonus + {{ selected_tier|badge_tier_xp }} XP/stage</span>
                    </div>
                </div>

                <!-- Stage Checklist (collapsible, open by default) -->
                <div class="collapse collapse-arrow bg-base-200/50 rounded-box border border-base-300">
                    <input type="checkbox" checked />
                    <div class="collapse-title py-2 min-h-0 text-sm font-bold italic text-base-content/70">
                        Stage Requirements ({{ tier_req_stages|length }} stages)
                    </div>
                    <div class="collapse-content">
                        <div class="flex flex-col gap-1.5">
                            {% for req in tier_req_stages %}
                                <div class="flex flex-row items-center gap-2 px-2 py-1.5 rounded-box {% if req.is_complete %}bg-success/10 border border-success/30{% else %}bg-base-200 border border-base-300{% endif %}">
                                    {% if target_profile %}
                                        {% if req.is_complete %}
                                            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 shrink-0" viewBox="0 0 24 24" fill="none" stroke="var(--color-success)" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>
                                        {% else %}
                                            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 shrink-0" viewBox="0 0 24 24" fill="none" stroke="var(--color-error)" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                                        {% endif %}
                                    {% else %}
                                        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 shrink-0 text-base-content/30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle></svg>
                                    {% endif %}
                                    <figure class="w-6 h-6 lg:w-8 lg:h-8 rounded shrink-0">
                                        <img src="{{ req.stage.stage_icon }}" alt="{{ req.stage.title }}" class="w-full object-cover rounded" loading="lazy" decoding="async" />
                                    </figure>
                                    <a href="#stage-{{ req.stage.stage_number }}" class="text-xs lg:text-sm text-base-content hover:text-accent transition-colors pr-1 line-clamp-1">
                                        <span class="text-accent font-bold">Stage {{ req.stage.stage_number }}:</span> {{ req.stage.title }}
                                    </a>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}
</div>