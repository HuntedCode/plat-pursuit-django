{% load static custom_filters humanize %}
{% with badge_series_stats as stats %}
{% if stats %}
    <div class="flex flex-col gap-3 mt-4">
        <!-- Series Stats -->
        <div class="flex flex-col gap-2">
            <span class="text-xs text-base-content/50 font-bold italic uppercase tracking-wide">Series Stats</span>
            <div class="grid grid-cols-2 lg:grid-cols-4 gap-2 lg:gap-3">
                <!-- Total Games -->
                <div class="flex flex-row items-center gap-2 bg-base-100 rounded-box border-2 border-base-300 px-3 py-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 shrink-0" viewBox="0 0 16 16" fill="var(--color-accent)" aria-hidden="true">
                        <path d="M11.5 6.027a.5.5 0 1 1-1 0 .5.5 0 0 1 1 0m-1.5 1.5a.5.5 0 1 0 0-1 .5.5 0 0 0 0 1m2.5-.5a.5.5 0 1 1-1 0 .5.5 0 0 1 1 0m-1.5 1.5a.5.5 0 1 0 0-1 .5.5 0 0 0 0 1m-6.5-3h1v1h1v1h-1v1h-1v-1h-1v-1h1z"/><path d="M3.051 3.26a.5.5 0 0 1 .354-.613l1.932-.518a.5.5 0 0 1 .62.39c.655-.079 1.35-.117 2.043-.117.72 0 1.443.041 2.12.126a.5.5 0 0 1 .622-.399l1.932.518a.5.5 0 0 1 .306.729q.211.136.373.297c.408.408.78 1.05 1.095 1.772.32.733.599 1.591.805 2.466s.34 1.78.364 2.606c.024.816-.059 1.602-.328 2.21a1.42 1.42 0 0 1-1.445.83c-.636-.067-1.115-.394-1.513-.773a11.3 11.3 0 0 1-.739-.809c-.126-.147-.25-.291-.368-.422-.728-.804-1.597-1.527-3.224-1.527s-2.496.723-3.224 1.527c-.119.131-.242.275-.368.422-.243.283-.494.576-.739.81-.398.378-.877.705-1.513.772a1.42 1.42 0 0 1-1.445-.83c-.27-.608-.352-1.395-.329-2.21.024-.826.16-1.73.365-2.606.206-.875.484-1.733.805-2.466.315-.722.687-1.364 1.094-1.772a2.3 2.3 0 0 1 .433-.335.5.5 0 0 1-.048-.745z"/>
                    </svg>
                    <div class="flex flex-col">
                        <span class="text-xs text-accent italic font-bold">Total Games</span>
                        <span class="text-lg font-bold">{{ stats.total_games }}</span>
                    </div>
                </div>

                <!-- Total Earners -->
                <div class="flex flex-row items-center gap-2 bg-base-100 rounded-box border-2 border-base-300 px-3 py-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 shrink-0" viewBox="0 0 24 24" fill="none" stroke="var(--color-primary)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                    </svg>
                    <div class="flex flex-col">
                        <span class="text-xs text-primary italic font-bold">Total Earners</span>
                        <span class="text-lg font-bold">{{ stats.tier_earner_counts.1|default:0|intcomma }}</span>
                    </div>
                </div>

                <!-- Avg Difficulty -->
                <div class="flex flex-row items-center gap-2 bg-base-100 rounded-box border-2 border-base-300 px-3 py-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 shrink-0" viewBox="0 0 24 24" fill="none" stroke="{% if stats.series_avg_difficulty != None %}{% if stats.series_avg_difficulty < 4 %}var(--color-success){% elif stats.series_avg_difficulty < 8 %}var(--color-warning){% else %}var(--color-error){% endif %}{% else %}var(--color-base-content){% endif %}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                        <circle cx="12" cy="12" r="10"/><path d="M16.2 7.8l-2 6.3-6.4 2.1 2-6.3z"/>
                    </svg>
                    <div class="flex flex-col">
                        <span class="text-xs {% if stats.series_avg_difficulty != None %}{% if stats.series_avg_difficulty < 4 %}text-success{% elif stats.series_avg_difficulty < 8 %}text-warning{% else %}text-error{% endif %}{% else %}text-base-content/50{% endif %} italic font-bold">Avg Difficulty</span>
                        {% if stats.series_avg_difficulty != None %}
                            <span class="text-lg font-bold">{{ stats.series_avg_difficulty }}<span class="text-sm text-base-content/50">/10</span></span>
                        {% else %}
                            <span class="text-lg font-bold text-base-content/30">-</span>
                        {% endif %}
                    </div>
                </div>

                <!-- Avg Hours -->
                <div class="flex flex-row items-center gap-2 bg-base-100 rounded-box border-2 border-base-300 px-3 py-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 shrink-0" viewBox="0 0 24 24" fill="none" stroke="{% if stats.series_avg_hours != None %}{% if stats.series_avg_hours < 25 %}var(--color-success){% elif stats.series_avg_hours < 75 %}var(--color-warning){% elif stats.series_avg_hours < 100 %}var(--color-accent){% else %}var(--color-error){% endif %}{% else %}var(--color-base-content){% endif %}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                        <circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline>
                    </svg>
                    <div class="flex flex-col">
                        <span class="text-xs {% if stats.series_avg_hours != None %}{% if stats.series_avg_hours < 25 %}text-success{% elif stats.series_avg_hours < 75 %}text-warning{% elif stats.series_avg_hours < 100 %}text-accent{% else %}text-error{% endif %}{% else %}text-base-content/50{% endif %} italic font-bold">Avg Hours</span>
                        {% if stats.series_avg_hours != None %}
                            <span class="text-lg font-bold">{{ stats.series_avg_hours }}<span class="text-sm text-base-content/50"> hrs</span></span>
                        {% else %}
                            <span class="text-lg font-bold text-base-content/30">-</span>
                        {% endif %}
                    </div>
                </div>

                <!-- Community Badges Earned -->
                <div class="flex flex-row items-center gap-2 bg-base-100 rounded-box border-2 border-base-300 px-3 py-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 shrink-0" viewBox="0 0 24 24" fill="none" stroke="var(--color-warning)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                        <circle cx="12" cy="8" r="7"></circle><polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88"></polyline>
                    </svg>
                    <div class="flex flex-col flex-1">
                        <span class="text-xs text-warning italic font-bold">Badges Earned</span>
                        <div class="flex flex-row items-center gap-2 lg:gap-3 mt-0.5">
                            {% for tier_num, count in stats.tier_earner_counts.items %}
                                {% with tier_num|stringformat:'s' as tier_str %}
                                <div class="flex flex-row items-center gap-1">
                                    <figure class="w-4 h-4 lg:w-5 lg:h-5">
                                        <img src="{% static 'images/badges/backdrops/'|add:tier_str|add:'_backdrop.png' %}" alt="{{ tier_num|badge_tier }}" class="w-full object-contain" loading="lazy" decoding="async" />
                                    </figure>
                                    <span class="text-xs font-bold">{{ count|intcomma }}</span>
                                </div>
                                {% endwith %}
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <!-- Max Tier Distribution -->
                <div class="flex flex-row items-center gap-2 bg-base-100 rounded-box border-2 border-base-300 px-3 py-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 shrink-0" viewBox="0 0 24 24" fill="none" stroke="var(--color-secondary)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                        <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
                    </svg>
                    <div class="flex flex-col flex-1">
                        <span class="text-xs text-secondary italic font-bold">Max Tier</span>
                        {% if stats.total_unique_earners %}
                            <div class="flex flex-row items-center gap-2 lg:gap-3 mt-0.5">
                                {% for tier_num, pct in stats.max_tier_pcts.items %}
                                    {% with tier_num|stringformat:'s' as tier_str %}
                                    <div class="flex flex-row items-center gap-0.5">
                                        <figure class="w-4 h-4 lg:w-5 lg:h-5">
                                            <img src="{% static 'images/badges/backdrops/'|add:tier_str|add:'_backdrop.png' %}" alt="{{ tier_num|badge_tier }}" class="w-full object-contain" loading="lazy" decoding="async" />
                                        </figure>
                                        <span class="text-xs font-bold">{{ pct }}%</span>
                                    </div>
                                    {% endwith %}
                                {% endfor %}
                            </div>
                        {% else %}
                            <span class="text-sm font-bold text-base-content/30 italic">No earners yet</span>
                        {% endif %}
                    </div>
                </div>

                <!-- XP Available -->
                <div class="flex flex-row items-center gap-2 bg-base-100 rounded-box border-2 border-base-300 px-3 py-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 shrink-0" viewBox="0 0 24 24" fill="none" stroke="var(--color-secondary)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                        <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon>
                    </svg>
                    <div class="flex flex-col">
                        <span class="text-xs text-secondary italic font-bold">XP Available</span>
                        <span class="text-lg font-bold">{{ stats.total_series_xp_available|intcomma }}<span class="text-sm text-base-content/50"> XP</span></span>
                    </div>
                </div>

                <!-- Community XP -->
                <div class="flex flex-row items-center gap-2 bg-base-100 rounded-box border-2 border-base-300 px-3 py-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 shrink-0" viewBox="0 0 24 24" fill="none" stroke="var(--color-info)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                        <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon>
                    </svg>
                    <div class="flex flex-col">
                        <span class="text-xs text-info italic font-bold">Community XP</span>
                        <span class="text-lg font-bold">{{ stats.community_total_xp|intcomma }}<span class="text-sm text-base-content/50"> XP</span></span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Your Stats (authenticated only) -->
        {% if target_profile %}
            <div class="flex flex-col gap-2">
                <span class="text-xs text-base-content/50 font-bold italic uppercase tracking-wide">Your Stats</span>
                <div class="grid grid-cols-2 lg:grid-cols-4 gap-2 lg:gap-3">
                    <!-- Playtime -->
                    <div class="flex flex-row items-center gap-2 bg-base-100 rounded-box border-2 border-base-300 px-3 py-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 shrink-0" viewBox="0 0 24 24" fill="none" stroke="var(--color-info)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                            <circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline>
                        </svg>
                        <div class="flex flex-col">
                            <span class="text-xs text-info italic font-bold">Playtime</span>
                            <span class="text-lg font-bold">{{ stats.user_total_playtime|timedelta_hours|default:'-' }}</span>
                        </div>
                    </div>

                    <!-- Games Played -->
                    <div class="flex flex-row items-center gap-2 bg-base-100 rounded-box border-2 border-base-300 px-3 py-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 shrink-0" viewBox="0 0 16 16" fill="var(--color-success)" aria-hidden="true">
                            <path d="M11.5 6.027a.5.5 0 1 1-1 0 .5.5 0 0 1 1 0m-1.5 1.5a.5.5 0 1 0 0-1 .5.5 0 0 0 0 1m2.5-.5a.5.5 0 1 1-1 0 .5.5 0 0 1 1 0m-1.5 1.5a.5.5 0 1 0 0-1 .5.5 0 0 0 0 1m-6.5-3h1v1h1v1h-1v1h-1v-1h-1v-1h1z"/><path d="M3.051 3.26a.5.5 0 0 1 .354-.613l1.932-.518a.5.5 0 0 1 .62.39c.655-.079 1.35-.117 2.043-.117.72 0 1.443.041 2.12.126a.5.5 0 0 1 .622-.399l1.932.518a.5.5 0 0 1 .306.729q.211.136.373.297c.408.408.78 1.05 1.095 1.772.32.733.599 1.591.805 2.466s.34 1.78.364 2.606c.024.816-.059 1.602-.328 2.21a1.42 1.42 0 0 1-1.445.83c-.636-.067-1.115-.394-1.513-.773a11.3 11.3 0 0 1-.739-.809c-.126-.147-.25-.291-.368-.422-.728-.804-1.597-1.527-3.224-1.527s-2.496.723-3.224 1.527c-.119.131-.242.275-.368.422-.243.283-.494.576-.739.81-.398.378-.877.705-1.513.772a1.42 1.42 0 0 1-1.445-.83c-.27-.608-.352-1.395-.329-2.21.024-.826.16-1.73.365-2.606.206-.875.484-1.733.805-2.466.315-.722.687-1.364 1.094-1.772a2.3 2.3 0 0 1 .433-.335.5.5 0 0 1-.048-.745z"/>
                        </svg>
                        <div class="flex flex-col">
                            <span class="text-xs text-success italic font-bold">Stages Played</span>
                            <span class="text-lg font-bold">{{ stats.user_stages_played }}/{{ stats.total_required_stages }}</span>
                        </div>
                    </div>

                    <!-- Platinums -->
                    <div class="flex flex-row items-center gap-2 bg-base-100 rounded-box border-2 border-base-300 px-3 py-2">
                        {% include 'partials/icons/trophy_cup.html' with color='var(--color-trophy-platinum)' size='w-6 h-6 shrink-0' %}
                        <div class="flex flex-col">
                            <span class="text-xs text-warning italic font-bold">Stages Platinumed</span>
                            <span class="text-lg font-bold">{{ stats.user_stages_platinumed }}/{{ stats.total_required_stages }}</span>
                        </div>
                    </div>

                    <!-- XP -->
                    <div class="flex flex-row items-center gap-2 bg-base-100 rounded-box border-2 border-base-300 px-3 py-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 shrink-0" viewBox="0 0 24 24" fill="none" stroke="var(--color-secondary)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                            <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon>
                        </svg>
                        <div class="flex flex-col">
                            <span class="text-xs text-secondary italic font-bold">Series XP</span>
                            <span class="text-lg font-bold">{{ stats.user_series_xp|intcomma }}<span class="text-sm text-base-content/50">/{{ stats.total_series_xp_available|intcomma }}</span></span>
                        </div>
                    </div>

                    <!-- Avg Progress -->
                    <div class="flex flex-row items-center gap-2 bg-base-100 rounded-box border-2 border-base-300 px-3 py-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 shrink-0" viewBox="0 0 24 24" fill="none" stroke="var(--color-accent)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                            <line x1="12" y1="20" x2="12" y2="10"></line><line x1="18" y1="20" x2="18" y2="4"></line><line x1="6" y1="20" x2="6" y2="16"></line>
                        </svg>
                        <div class="flex flex-col">
                            <span class="text-xs text-accent italic font-bold">Avg Progress</span>
                            <span class="text-lg font-bold">{{ stats.avg_progress }}%</span>
                        </div>
                    </div>

                    {% if stats.user_lb_rank %}
                        <!-- Rank -->
                        <div class="flex flex-row items-center gap-2 bg-base-100 rounded-box border-2 border-base-300 px-3 py-2">
                            {% include 'partials/icons/trophy_cup.html' with color='var(--color-warning)' size='w-6 h-6 shrink-0' %}
                            <div class="flex flex-col">
                                <span class="text-xs text-warning italic font-bold">Rank</span>
                                <span class="text-lg font-bold">#{{ stats.user_lb_rank }}</span>
                            </div>
                        </div>
                    {% endif %}

                    <!-- Trophies Earned -->
                    <div class="flex flex-row items-center gap-2 bg-base-100 rounded-box border-2 border-base-300 px-3 py-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 shrink-0" viewBox="0 0 24 24" fill="none" stroke="var(--color-info)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                            <path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"></path><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"></path><path d="M4 22h16"></path><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"></path><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"></path><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"></path>
                        </svg>
                        <div class="flex flex-col flex-1">
                            <span class="text-xs text-info italic font-bold">Trophies</span>
                            <div class="flex flex-row items-center gap-1.5 mt-0.5">
                                <div class="flex items-center gap-0.5">
                                    {% include 'partials/icons/trophy_cup.html' with color='var(--color-trophy-bronze)' size='w-3 h-3' %}
                                    <span class="text-xs font-bold">{{ stats.user_trophy_breakdown.bronze }}</span>
                                </div>
                                <div class="flex items-center gap-0.5">
                                    {% include 'partials/icons/trophy_cup.html' with color='var(--color-trophy-silver)' size='w-3 h-3' %}
                                    <span class="text-xs font-bold">{{ stats.user_trophy_breakdown.silver }}</span>
                                </div>
                                <div class="flex items-center gap-0.5">
                                    {% include 'partials/icons/trophy_cup.html' with color='var(--color-trophy-gold)' size='w-3 h-3' %}
                                    <span class="text-xs font-bold">{{ stats.user_trophy_breakdown.gold }}</span>
                                </div>
                                <div class="flex items-center gap-0.5">
                                    {% include 'partials/icons/trophy_cup.html' with color='var(--color-trophy-platinum)' size='w-3 h-3' %}
                                    <span class="text-xs font-bold">{{ stats.user_trophy_breakdown.platinum }}</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Journey Start -->
                    {% if stats.first_played %}
                        <div class="flex flex-row items-center gap-2 bg-base-100 rounded-box border-2 border-base-300 px-3 py-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 shrink-0" viewBox="0 0 24 24" fill="none" stroke="var(--color-accent)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line>
                            </svg>
                            <div class="flex flex-col">
                                <span class="text-xs text-accent italic font-bold">Journey Start</span>
                                <span class="text-lg font-bold">{{ stats.first_played|date:"M j, Y" }}</span>
                            </div>
                        </div>
                    {% endif %}

                    <!-- Last Trophy -->
                    {% if stats.most_recent_trophy %}
                        <div class="flex flex-row items-center gap-2 bg-base-100 rounded-box border-2 border-base-300 px-3 py-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 shrink-0" viewBox="0 0 24 24" fill="none" stroke="var(--color-success)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                <circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline>
                            </svg>
                            <div class="flex flex-col">
                                <span class="text-xs text-success italic font-bold">Last Trophy</span>
                                <span class="text-lg font-bold">{{ stats.most_recent_trophy|date:"M j, Y" }}</span>
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>
        {% endif %}
    </div>
{% endif %}
{% endwith %}