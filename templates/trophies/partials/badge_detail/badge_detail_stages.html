{% load static custom_filters %}
<div class="card bg-base-100 border-4 border-base-300 shadow-md shadow-neutral mb-1 transition-all duration-300 hover:border-primary hover:shadow-primary">
    <div class="card-body p-2 lg:p-3">
        <div class="flex flex-row items-center gap-2 lg:gap-3">
            <!-- Stage Icon -->
            <figure class="w-10 lg:w-14 h-10 lg:h-14 border-2 border-base-300 rounded-box shrink-0 hover:scale-105 transition-all duration-300">
                <img src="{{ stage.stage_icon }}" alt="{{ stage.title }}" class="w-full h-full object-cover rounded-box" loading="lazy" decoding="async" />
            </figure>

            <!-- Stage Title + Completion Indicator -->
            <div class="flex flex-col gap-1 flex-1 min-w-0">
                <div class="flex flex-row items-center gap-2">
                    <h2 class="text-sm lg:text-xl font-semibold italic pr-1 line-clamp-1">
                        <span class="lg:hidden text-accent font-bold">{% if stage.stage_number == 0 %}Bonus{% else %}Stage {{ stage.stage_number }}{% endif %}:</span>
                        {{ stage.title }}
                    </h2>
                    {% if target_profile and data.stage_completion_state and stage.stage_number != 0 %}
                        {% if data.stage_completion_state == 'complete' %}
                            <div class="tooltip" data-tip="Stage complete">
                                <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-success shrink-0" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><polyline points="20 6 9 17 4 12"></polyline></svg>
                            </div>
                        {% elif data.stage_completion_state == 'partial' %}
                            <div class="tooltip" data-tip="Platinum earned">
                                <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-warning shrink-0" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><polyline points="20 6 9 17 4 12"></polyline></svg>
                            </div>
                        {% else %}
                            <div class="tooltip" data-tip="Incomplete">
                                <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-error shrink-0" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                            </div>
                        {% endif %}
                    {% endif %}
                </div>
            </div>

            <!-- Tier Indicators -->
            {% if stage.stage_number != 0 %}
                <div class="flex flex-row gap-1 lg:gap-2 shrink-0" role="list" aria-label="Badge tier status">
                    {% if not stage.required_tiers %}
                        {% for i in '1234' %}
                            {% with completion|dict_get:i as comp %}
                            {% with stage.stage_number as num %}
                            {% with comp|dict_get:num as earned %}
                                <a href="#tier-selector" class="tooltip" data-tip="{{ i|badge_tier }}" role="listitem">
                                    <figure class="relative w-5 h-5 lg:w-7 lg:h-7 hover:scale-110 transition-transform">
                                        <img src="{% static 'images/badges/backdrops/'|add:i|add:'_backdrop.png' %}" alt="{{ i|badge_tier }}" class="absolute inset-0 w-full {% if not earned %}grayscale{% endif %}" loading="lazy" decoding="async" />
                                        {% if earned %}
                                            <svg xmlns="http://www.w3.org/2000/svg" class="absolute inset-0 w-full" viewBox="0 0 24 24" fill="none" stroke="var(--color-success)" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><polyline points="20 6 9 17 4 12"></polyline></svg>
                                        {% endif %}
                                    </figure>
                                </a>
                            {% endwith %}
                            {% endwith %}
                            {% endwith %}
                        {% endfor %}
                    {% else %}
                        {% for i in stage.required_tiers %}
                            {% with completion|dict_get:i as comp %}
                            {% with stage.stage_number as num %}
                            {% with comp|dict_get:num as earned %}
                                <a href="#tier-selector" class="tooltip" data-tip="{{ i|badge_tier }}" role="listitem">
                                    <figure class="relative w-5 h-5 lg:w-7 lg:h-7 hover:scale-110 transition-transform">
                                        {% with i|stringformat:'s' as i_str %}
                                            <img src="{% static 'images/badges/backdrops/'|add:i_str|add:'_backdrop.png' %}" alt="{{ i|badge_tier }}" class="absolute inset-0 w-full {% if not earned %}grayscale{% endif %}" loading="lazy" decoding="async" />
                                        {% endwith %}
                                        {% if earned %}
                                            <svg xmlns="http://www.w3.org/2000/svg" class="absolute inset-0 w-full" viewBox="0 0 24 24" fill="none" stroke="var(--color-success)" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><polyline points="20 6 9 17 4 12"></polyline></svg>
                                        {% endif %}
                                    </figure>
                                </a>
                            {% endwith %}
                            {% endwith %}
                            {% endwith %}
                        {% endfor %}
                    {% endif %}
                </div>
            {% endif %}
        </div>
    </div>
</div>