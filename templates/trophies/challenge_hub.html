{% extends 'base.html' %}
{% load static custom_filters %}

{% block title %}Challenges - Platinum Pursuit{% endblock %}

{% block content %}
{# ─── Header ─────────────────────────────────────────────────────────── #}
<section class="shadow-lg shadow-neutral bg-base-200/80 rounded-box border-2 border-base-300 w-full p-0 lg:p-4">
    {% include 'partials/breadcrumb.html' with items=breadcrumb %}

    <div class="card bg-base-100 border-4 border-base-300 shadow-md shadow-neutral">
        <div class="card-body">
            <div class="flex flex-row items-center justify-between gap-4">
                <div>
                    <h1 class="text-2xl lg:text-3xl font-bold">Challenge Hub</h1>
                    <p class="text-base-content/70">
                        Push your limits, track your progress, and find inspiration from the community.
                    </p>
                </div>
                {% if user.is_authenticated and user.profile %}
                    <a href="{% url 'my_challenges' %}" class="btn btn-primary btn-md">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 mr-1" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                        </svg>
                        My Challenges
                    </a>
                {% endif %}
            </div>
        </div>
    </div>
</section>

{# ─── Challenge Type Tabs ────────────────────────────────────────────── #}
<div class="tabs tabs-box mt-6 bg-base-300/80" role="tablist" aria-label="Challenge types">

    {# ── A-Z Platinum Tab ────────────────────────────────────────────── #}
    <a href="?type=az" id="az-tab"
       class="tab {% if current_type == 'az' %}tab-active{% endif %}"
       role="tab"
       aria-selected="{% if current_type == 'az' %}true{% else %}false{% endif %}"
       aria-controls="az-panel">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 mr-2" viewBox="0 0 24 24" aria-hidden="true">
            <text x="3" y="18" font-size="16" font-weight="bold" font-family="system-ui, sans-serif"
                  fill="var(--color-accent)" letter-spacing="-1">AZ</text>
        </svg>
        A-Z Challenge
        {% if az_total_count %}<span class="badge badge-sm ml-1">{{ az_total_count }}</span>{% endif %}
    </a>
    <div id="az-panel"
         class="tab-content bg-base-100/90 border-2 border-base-300 shadow-md shadow-neutral p-0"
         role="tabpanel" aria-labelledby="az-tab">
        {% if current_type == 'az' %}
            {% include 'partials/challenge_hub_panel.html' %}
        {% endif %}
    </div>

    {# ── Platinum Calendar Tab ───────────────────────────────────────── #}
    <a href="?type=calendar" id="calendar-tab"
       class="tab {% if current_type == 'calendar' %}tab-active{% endif %}"
       role="tab"
       aria-selected="{% if current_type == 'calendar' %}true{% else %}false{% endif %}"
       aria-controls="calendar-panel">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 mr-2" viewBox="0 0 24 24" fill="none"
             stroke="var(--color-warning)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
            <line x1="16" y1="2" x2="16" y2="6"></line>
            <line x1="8" y1="2" x2="8" y2="6"></line>
            <line x1="3" y1="10" x2="21" y2="10"></line>
        </svg>
        Platinum Calendar
        {% if cal_total_count %}<span class="badge badge-sm ml-1">{{ cal_total_count }}</span>{% endif %}
    </a>
    <div id="calendar-panel"
         class="tab-content bg-base-100/90 border-2 border-base-300 shadow-md shadow-neutral p-0"
         role="tabpanel" aria-labelledby="calendar-tab">
        {% if current_type == 'calendar' %}
            {% include 'partials/challenge_hub_panel.html' %}
        {% endif %}
    </div>

    {# ── Genre Challenge Tab ───────────────────────────────────────── #}
    <a href="?type=genre" id="genre-tab"
       class="tab {% if current_type == 'genre' %}tab-active{% endif %}"
       role="tab"
       aria-selected="{% if current_type == 'genre' %}true{% else %}false{% endif %}"
       aria-controls="genre-panel">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 mr-2" viewBox="0 0 24 24" fill="none"
             stroke="var(--color-secondary)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"></path>
            <line x1="4" y1="22" x2="4" y2="15"></line>
        </svg>
        Genre Challenge
        {% if genre_total_count %}<span class="badge badge-sm ml-1">{{ genre_total_count }}</span>{% endif %}
    </a>
    <div id="genre-panel"
         class="tab-content bg-base-100/90 border-2 border-base-300 shadow-md shadow-neutral p-0"
         role="tabpanel" aria-labelledby="genre-tab">
        {% if current_type == 'genre' %}
            {% include 'partials/challenge_hub_panel.html' %}
        {% endif %}
    </div>

</div>
{% endblock %}

{% block js_scripts %}
<script>PlatPursuit.ZoomScaler.init();</script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const scrollKey = 'challengeHubScrollPos';
        const saved = sessionStorage.getItem(scrollKey);
        if (saved !== null) {
            sessionStorage.removeItem(scrollKey);
            window.scrollTo(0, parseInt(saved, 10));
        }
        document.querySelectorAll('.tabs [role="tab"]').forEach(tab => {
            tab.addEventListener('click', () => {
                sessionStorage.setItem(scrollKey, window.scrollY);
            });
        });

        // Infinite scroll for challenge cards
        PlatPursuit.InfiniteScroller.create({
            gridId: 'hub-card-grid',
            sentinelId: 'hub-scroll-sentinel',
            loadingId: 'hub-scroll-loading',
            paginateBy: 12,
            cardSelector: '.card',
            scrollKey: scrollKey
        });
    });
</script>
{% endblock %}
