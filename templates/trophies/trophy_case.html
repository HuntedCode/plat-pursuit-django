{% extends 'base.html' %}
{% load static %}
{% block title %}{{ profile.display_psn_username }} - Trophy Case{% endblock %}

{% block content %}
    {% include 'partials/breadcrumb.html' with items=breadcrumb %}
    <h1 class="text-base sm:text-lg md:text-xl lg:text-2xl xl:text-3xl text-base-content text-center line-clamp-1"><span class="font-bold italic">{{ profile.display_psn_username }}'s</span> <span class="text-trophy-platinum font-bold">Platinum</span> Trophy Case!</h1>
    <div class="divider divider-vertical"></div>
    <div id="items-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 2xl:grid-cols-5 gap-4">
        {% include 'trophies/partials/trophy_case/trophy_case_items.html' %}
    </div>
    {% if request.user == profile.user %}
        <div class="fixed bottom-4 right-4 bg-base-100 p-2 rounded-box shadow-md shadow-accent border-4 border-accent z-20">
            <span id="selected-counter" class="font-bold">Selected: {{ selected_count }}/10</span>
        </div>
    {% endif %}
    <div id="loading" class="hidden mt-4 text-center">
        <span class="loading loading-spinner loading-lg"></span>
    </div>
    <div id="sentinel" class="h-1"></div>
{% endblock %}

{% block js_scripts %}
    <script src="{% static 'js\infinite_scroll.js' %}"></script>
    <script>
        const toggleSelectionUrl = "{{ toggle_selection_url }}";
        let selectedCount = {{ selected_count }};
        document.addEventListener('DOMContentLoaded', function() {
            const grid = document.getElementById('items-grid');
            if (!grid) return;

            grid.addEventListener('click', function(event) {
                const card = event.target.closest('.card');
                if (!card) return;

                const earned_trophy_id = card.dataset.id;
                if (!earned_trophy_id) return;

                const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                const counter = document.getElementById('selected-counter');
                if (selectedCount < 10 || card.classList.contains('selected')) {
                    fetch(toggleSelectionUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                            'X-CSRFToken': csrfToken
                        },
                        body: new URLSearchParams({
                            'earned_trophy_id': earned_trophy_id
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            if (data.action === 'added') {
                                card.classList.add('border-primary', 'shadow-primary', 'scale-103', 'selected');
                                selectedCount++;
                            } else {
                                card.classList.remove('border-primary', 'shadow-primary', 'scale-103', 'selected');
                                selectedCount--;
                            }
                            counter.textContent = `Selected: ${selectedCount}/10`;
                        } else {
                            console.error('Toggle failed');

                            card.classList.add('border-error', 'shake');
                            setTimeout(() => card.classList.remove('border-error', 'shake'), 750);
                        }
                    })
                    .catch(error => console.error('Error:', error))
                } else {
                    card.classList.add('border-error', 'shake');
                    setTimeout(() => card.classList.remove('border-error', 'shake'), 750);
                }
            });
        });
    </script>
{% endblock %}