{% extends 'base.html' %}
{% load static %}
{% block title %}{{ profile.display_psn_username }} - Trophy Case{% endblock %}

{% block content %}
    {% include 'partials/breadcrumb.html' with items=breadcrumb %}
    <h1 class="text-base sm:text-lg md:text-xl lg:text-2xl xl:text-3xl text-base-content text-center line-clamp-1"><span class="font-bold italic">{{ profile.display_psn_username }}'s</span> <span class="text-trophy-platinum font-bold">Platinum</span> Trophy Case!</h1>
    <div class="divider divider-vertical"></div>

    {% if is_paginated %}
        <div class="flex flex-col md:flex-row justify-center items-center gap-2 mb-6">
            <div class="btn-group">
                {% if page_obj.has_previous %}
                    <a href="?{% querystring exclude='page' %}&page=1#filter-form" class="btn btn-outline btn-xs sm:btn-sm md:btn-md">&laquo; First</a>
                    <a href="?{% querystring exclude='page' %}&page={{ page_obj.previous_page_number }}#filter-form" class="btn btn-outline btn-xs sm:btn-sm md:btn-md">Previous</a>
                {% endif %}
                
                <span class="btn btn-active btn-xs sm:btn-sm md:btn-md">Page {{ page_obj.number }} of {{ paginator.num_pages }}</span>
                
                {% if page_obj.has_next %}
                    <a href="?{% querystring exclude='page' %}&page={{ page_obj.next_page_number }}#filter-form" class="btn btn-outline btn-xs sm:btn-sm md:btn-md">Next</a>
                    <a href="?{% querystring exclude='page' %}&page={{ paginator.num_pages }}#filter-form" class="btn btn-outline btn-xs sm:btn-sm md:btn-md">Last &raquo;</a>
                {% endif %}
            </div>

            <form id="page-jump-form" method="get" class="form-control flex-row items-center space-x-2 ml-4">
                <label class="label font-semibold" for="page-input">Go to page:</label>
                <input type="number" id="page-input" name="page" min="1" max="{{ paginator.num_pages }}" value="{{ page_obj.number }}" class="input w-20" />
                <button type="submit" class="btn btn-primary btn-sm">Go</button>
            </form>
        </div>
    {% endif %}

    <div id="items-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 2xl:grid-cols-5 gap-4">
        {% include 'trophies/partials/trophy_case/trophy_case_items.html' %}
    </div>

    {% if is_paginated %}
        <div class="flex flex-col md:flex-row justify-center items-center gap-2 mt-6">
            <div class="btn-group">
                {% if page_obj.has_previous %}
                    <a href="?{% querystring exclude='page' %}&page=1#filter-form" class="btn btn-outline btn-xs sm:btn-sm md:btn-md">&laquo; First</a>
                    <a href="?{% querystring exclude='page' %}&page={{ page_obj.previous_page_number }}#filter-form" class="btn btn-outline btn-xs sm:btn-sm md:btn-md">Previous</a>
                {% endif %}
                
                <span class="btn btn-active btn-xs sm:btn-sm md:btn-md">Page {{ page_obj.number }} of {{ paginator.num_pages }}</span>
                
                {% if page_obj.has_next %}
                    <a href="?{% querystring exclude='page' %}&page={{ page_obj.next_page_number }}#filter-form" class="btn btn-outline btn-xs sm:btn-sm md:btn-md">Next</a>
                    <a href="?{% querystring exclude='page' %}&page={{ paginator.num_pages }}#filter-form" class="btn btn-outline btn-xs sm:btn-sm md:btn-md">Last &raquo;</a>
                {% endif %}
            </div>
        </div>
    {% endif %}

    {% if request.user == profile.user %}
        <div class="fixed bottom-4 right-4 bg-base-100 p-2 rounded-box shadow-md shadow-accent border-4 border-accent z-20">
            <span id="selected-counter" class="font-bold">Selected: {{ selected_count }}/{{ max_selections }}</span>
        </div>
    {% endif %}

{% endblock %}

{% block js_scripts %}
    <script>
        document.getElementById('page-jump-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const newPage = document.getElementById('page-input').value;
            const currentParams = new URLSearchParams(window.location.search);
            currentParams.set('page', newPage);
            
            const newUrl = `${window.location.pathname}?${currentParams.toString()}#filter-form`;
            
            window.location.href = newUrl;
        });
    </script>
    <script>
        const toggleSelectionUrl = "{{ toggle_selection_url }}";
        let selectedCount = {{ selected_count }};
        const maxSelections = {{ max_selections }};
        document.addEventListener('DOMContentLoaded', function() {
            const grid = document.getElementById('items-grid');
            if (!grid) return;

            grid.addEventListener('click', function(event) {
                const card = event.target.closest('.card');
                if (!card) return;

                const earned_trophy_id = card.dataset.id;
                if (!earned_trophy_id) return;

                const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                const counter = document.getElementById('selected-counter');
                if (selectedCount < maxSelections || card.classList.contains('selected')) {
                    fetch(toggleSelectionUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                            'X-CSRFToken': csrfToken
                        },
                        body: new URLSearchParams({
                            'earned_trophy_id': earned_trophy_id
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            if (data.action === 'added') {
                                card.classList.add('border-primary', 'shadow-primary', 'scale-103', 'selected');
                                selectedCount++;
                            } else {
                                card.classList.remove('border-primary', 'shadow-primary', 'scale-103', 'selected');
                                selectedCount--;
                            }
                            counter.textContent = `Selected: ${selectedCount}/${maxSelections}`;
                        } else {
                            console.error('Toggle failed');

                            card.classList.add('border-error', 'shake');
                            setTimeout(() => card.classList.remove('border-error', 'shake'), 750);
                        }
                    })
                    .catch(error => console.error('Error:', error))
                } else {
                    card.classList.add('border-error', 'shake');
                    setTimeout(() => card.classList.remove('border-error', 'shake'), 750);
                }
            });
        });
    </script>
{% endblock %}