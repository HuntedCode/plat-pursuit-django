{% extends 'base.html' %}
{% load static %}
{% load query_tags %}
{% block title %}{{ profile.display_psn_username }} - Trophy Case{% endblock %}

{% block content %}
    {% include 'partials/breadcrumb.html' with items=breadcrumb %}
    <h1 class="text-base sm:text-lg md:text-xl lg:text-2xl xl:text-3xl text-base-content text-center line-clamp-1"><span class="font-bold italic">{{ profile.display_psn_username }}'s</span> <span class="text-trophy-platinum font-bold">Platinum</span> Trophy Case!</h1>
    <div class="divider divider-vertical"></div>

    <form id="filter-form" method="get" class="mb-4">
        <div class="flex justify-center">
            <div class="form-control fieldset w-full lg:w-75/100">
                <legend class="fieldset-legend text-lg lg:text-xl italic">Search By Game Name</legend>
                <div class="flex flex-col md:flex-row justify-self-center gap-4 w-full md:w-15/16">
                    <input type="text" name="query" id="id_query" value="{{ request.GET.query }}" class="input input-md md:input-lg input-primary w-23/24 justify-self-center" placeholder="Enter game name..." />
                    <button id="submit-btn" type="submit" class="btn btn-md md:btn-lg border-3 shadow-md" disabled>Feel The Power...</button>
                </div>
            </div>
        </div>
    </form> 

    {% include 'partials/pagination.html' with position='top' show_page_jump=True anchor='filter-form' %}

    <div id="items-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 2xl:grid-cols-5 gap-4">
        {% include 'trophies/partials/trophy_case/trophy_case_items.html' %}
    </div>

    {% include 'partials/pagination.html' with position='bottom' show_page_jump=False anchor='filter-form' %}

    {% if request.user == profile.user %}
        <div class="fixed bottom-4 right-4 bg-base-100 p-2 rounded-box shadow-md shadow-accent border-4 border-accent z-20">
            <span id="selected-counter" class="font-bold">Selected: {{ selected_count }}/{{ max_selections }}</span>
        </div>
    {% endif %}

{% endblock %}

{% block js_scripts %}
    <script src="{% static 'js/submit_shimmer.js' %}"></script>
    <script src="{% static 'js/list_page_filters.js' %}"></script>
    <script>
        const toggleSelectionUrl = "{{ toggle_selection_url }}";
        let selectedCount = {{ selected_count }};
        const maxSelections = {{ max_selections }};
        document.addEventListener('DOMContentLoaded', function() {
            const grid = document.getElementById('items-grid');
            if (!grid) return;

            grid.addEventListener('click', function(event) {
                const card = event.target.closest('.card');
                if (!card) return;

                const earned_trophy_id = card.dataset.id;
                if (!earned_trophy_id) return;

                const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                const counter = document.getElementById('selected-counter');
                if (selectedCount < maxSelections || card.classList.contains('selected')) {
                    fetch(toggleSelectionUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                            'X-CSRFToken': csrfToken
                        },
                        body: new URLSearchParams({
                            'earned_trophy_id': earned_trophy_id
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            if (data.action === 'added') {
                                card.classList.add('border-primary', 'shadow-primary', 'scale-103', 'selected');
                                selectedCount++;
                            } else {
                                card.classList.remove('border-primary', 'shadow-primary', 'scale-103', 'selected');
                                selectedCount--;
                            }
                            counter.textContent = `Selected: ${selectedCount}/${maxSelections}`;
                        } else {
                            console.error('Toggle failed');

                            card.classList.add('border-error', 'shake');
                            setTimeout(() => card.classList.remove('border-error', 'shake'), 750);
                        }
                    })
                    .catch(error => console.error('Error:', error))
                } else {
                    card.classList.add('border-error', 'shake');
                    setTimeout(() => card.classList.remove('border-error', 'shake'), 750);
                }
            });
        });
    </script>
{% endblock %}