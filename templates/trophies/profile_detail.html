{% extends 'base.html' %}
{% load custom_filters humanize static %}
{% block title %}{{ profile.display_psn_username }}{% endblock %}
{% block og_image %}{% if profile.avatar_url %}{{ profile.avatar_url }}{% else %}{{ request.scheme }}://{{ request.get_host }}{{ logo_path }}{% endif %}{% endblock %}
{% block twitter_image %}{% if profile.avatar_url %}{{ profile.avatar_url }}{% else %}{{ request.scheme }}://{{ request.get_host }}{{ logo_path }}{% endif %}{% endblock %}

{% block content %}
    {% include 'partials/breadcrumb.html' with items=breadcrumb view_count=view_count %}

    {% include 'trophies/partials/profile_detail/profile_detail_header.html' %}

    {% include 'partials/ad_unit.html' with ad_slot="1939843878" %}

    {% if profile.psn_history_public %}
        <div class="tabs tabs-box mt-8 bg-base-300/80" role="tablist" aria-label="Profile sections">
            <a href="?tab=games" id="games-tab" class="tab {% if current_tab == 'games' %}tab-active{% endif %}" role="tab" aria-selected="{% if current_tab == 'games' %}true{% else %}false{% endif %}" aria-controls="games-panel">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 mr-2" fill="var(--color-accent)" viewBox="0 0 16 16" aria-hidden="true">
                    <path d="M11.5 6.027a.5.5 0 1 1-1 0 .5.5 0 0 1 1 0m-1.5 1.5a.5.5 0 1 0 0-1 .5.5 0 0 0 0 1m2.5-.5a.5.5 0 1 1-1 0 .5.5 0 0 1 1 0m-1.5 1.5a.5.5 0 1 0 0-1 .5.5 0 0 0 0 1m-6.5-3h1v1h1v1h-1v1h-1v-1h-1v-1h1z"/>
                    <path d="M3.051 3.26a.5.5 0 0 1 .354-.613l1.932-.518a.5.5 0 0 1 .62.39c.655-.079 1.35-.117 2.043-.117.72 0 1.443.041 2.12.126a.5.5 0 0 1 .622-.399l1.932.518a.5.5 0 0 1 .306.729q.211.136.373.297c.408.408.78 1.05 1.095 1.772.32.733.599 1.591.805 2.466s.34 1.78.364 2.606c.024.816-.059 1.602-.328 2.21a1.42 1.42 0 0 1-1.445.83c-.636-.067-1.115-.394-1.513-.773-.245-.232-.496-.526-.739-.808-.126-.148-.25-.292-.368-.423-.728-.804-1.597-1.527-3.224-1.527s-2.496.723-3.224 1.527c-.119.131-.242.275-.368.423-.243.282-.494.575-.739.808-.398.38-.877.706-1.513.773a1.42 1.42 0 0 1-1.445-.83c-.27-.608-.352-1.395-.329-2.21.024-.826.16-1.73.365-2.606.206-.875.486-1.733.805-2.466.315-.722.687-1.364 1.094-1.772a2.3 2.3 0 0 1 .433-.335l-.028-.079zm2.036.412c-.877.185-1.469.443-1.733.708-.276.276-.587.783-.885 1.465a14 14 0 0 0-.748 2.295 12.4 12.4 0 0 0-.339 2.406c-.022.755.062 1.368.243 1.776a.42.42 0 0 0 .426.24c.327-.034.61-.199.929-.502.212-.202.4-.423.615-.674.133-.156.276-.323.44-.504C4.861 9.969 5.978 9.027 8 9.027s3.139.942 3.965 1.855c.164.181.307.348.44.504.214.251.403.472.615.674.318.303.601.468.929.503a.42.42 0 0 0 .426-.241c.18-.408.265-1.02.243-1.776a12.4 12.4 0 0 0-.339-2.406 14 14 0 0 0-.748-2.295c-.298-.682-.61-1.19-.885-1.465-.264-.265-.856-.523-1.733-.708-.85-.179-1.877-.27-2.913-.27s-2.063.091-2.913.27"/>
                </svg>
                Games
            </a>
            <div id="games-panel" class="tab-content bg-base-100/90 border-2 border-base-300 shadow-md shadow-neutral p-4" role="tabpanel" aria-labelledby="games-tab">
                {% include 'trophies/partials/profile_detail/game_filters.html' %}
                <div class="divider divider-vertical"></div>
                <div id="games-grid" class="flex flex-col gap-2">
                    {% include 'trophies/partials/profile_detail/game_list_items.html' %}
                </div>
                <div id="games-loading" class="hidden mt-4 text-center" role="status" aria-live="polite">
                    <span class="loading loading-spinner loading-lg"></span>
                    <span class="sr-only">Loading more games...</span>
                </div>

                <div id="games-sentinel" class="h-1"></div>
            </div>
            <a href="?tab=trophies" id="trophies-tab" class="tab {% if current_tab == 'trophies' %}tab-active{% endif %}" role="tab" aria-selected="{% if current_tab == 'trophies' %}true{% else %}false{% endif %}" aria-controls="trophies-panel">
                {% include 'partials/icons/trophy_cup.html' with color='var(--color-warning)' size='w-6 h-6' extra_class='mr-2' %}
                Trophy Log
            </a>
            <div id="trophies-panel" class="tab-content bg-base-100/90 border-2 border-base-300 shadow-md shadow-neutral p-4" role="tabpanel" aria-labelledby="trophies-tab">
                {% include 'trophies/partials/profile_detail/trophy_log_filters.html' %}
                <div class="divider divider-vertical"></div>
                <div id="trophies-grid" class="flex flex-col gap-2">
                    {% include 'trophies/partials/profile_detail/trophy_list_items.html' %}
                </div>
                <div id="trophies-loading" class="hidden mt-4 text-center" role="status" aria-live="polite">
                    <span class="loading loading-spinner loading-lg"></span>
                    <span class="sr-only">Loading more trophies...</span>
                </div>

                <div id="trophies-sentinel" class="h-1"></div>
            </div>
            <a href="?tab=badges" id="badges-tab" class="tab {% if current_tab == 'badges' %}tab-active{% endif %}" role="tab" aria-selected="{% if current_tab == 'badges' %}true{% else %}false{% endif %}" aria-controls="badges-panel">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 mr-2" fill="var(--color-error)" viewBox="0 0 16 16" aria-hidden="true">
                    <path d="M5.338 1.59a61 61 0 0 0-2.837.856.48.48 0 0 0-.328.39c-.554 4.157.726 7.19 2.253 9.188a10.7 10.7 0 0 0 2.287 2.233c.346.244.652.42.893.533q.18.085.293.118a1 1 0 0 0 .101.025 1 1 0 0 0 .1-.025q.114-.034.294-.118c.24-.113.547-.29.893-.533a10.7 10.7 0 0 0 2.287-2.233c1.527-1.997 2.807-5.031 2.253-9.188a.48.48 0 0 0-.328-.39c-.651-.213-1.75-.56-2.837-.855C9.552 1.29 8.531 1.067 8 1.067c-.53 0-1.552.223-2.662.524zM5.072.56C6.157.265 7.31 0 8 0s1.843.265 2.928.56c1.11.3 2.229.655 2.887.87a1.54 1.54 0 0 1 1.044 1.262c.596 4.477-.787 7.795-2.465 9.99a11.8 11.8 0 0 1-2.517 2.453 7 7 0 0 1-1.048.625c-.28.132-.581.24-.829.24s-.548-.108-.829-.24a7 7 0 0 1-1.048-.625 11.8 11.8 0 0 1-2.517-2.453C1.928 10.487.545 7.169 1.141 2.692A1.54 1.54 0 0 1 2.185 1.43 63 63 0 0 1 5.072.56"/>
                </svg>
                Badges
            </a>
            <div id="badges-panel" class="tab-content bg-base-100/90 border-2 border-base-300 shadow-md shadow-neutral p-4" role="tabpanel" aria-labelledby="badges-tab">
                {% include 'trophies/partials/profile_detail/badge_filters.html' %}
                <div class="divider divider-vertical"></div>
                <div id="badges-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-3 xl:grid-cols-4 2xl:grid-cols-5 gap-3">
                    {% include 'trophies/partials/profile_detail/badge_list_items.html' %}
                </div>
            </div>
            <a href="?tab=lists" id="lists-tab" class="tab {% if current_tab == 'lists' %}tab-active{% endif %}" role="tab" aria-selected="{% if current_tab == 'lists' %}true{% else %}false{% endif %}" aria-controls="lists-panel">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="var(--color-info)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                    <line x1="8" y1="6" x2="21" y2="6"></line>
                    <line x1="8" y1="12" x2="21" y2="12"></line>
                    <line x1="8" y1="18" x2="21" y2="18"></line>
                    <line x1="3" y1="6" x2="3.01" y2="6"></line>
                    <line x1="3" y1="12" x2="3.01" y2="12"></line>
                    <line x1="3" y1="18" x2="3.01" y2="18"></line>
                </svg>
                Lists{% if profile_lists_count %} ({{ profile_lists_count }}){% endif %}
            </a>
            <div id="lists-panel" class="tab-content bg-base-100/90 border-2 border-base-300 shadow-md shadow-neutral p-4" role="tabpanel" aria-labelledby="lists-tab">
                {% if profile_lists %}
                    <div id="lists-grid" class="grid grid-cols-2 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                        {% for game_list in profile_lists %}
                            {% include 'partials/game_list_card.html' with game_list=game_list %}
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="text-center py-8">
                        <p class="text-base-content/60 italic">No public lists yet.</p>
                    </div>
                {% endif %}
            </div>
        </div>
    {% endif %}
{% endblock %}
{% block js_scripts %}
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const currentTab = new URLSearchParams(window.location.search).get('tab') || 'games';
        const baseUrl = window.location.pathname;
        const scrollKey = 'profileTabScrollPos';

        // Restore scroll position from tab switch
        const savedScroll = sessionStorage.getItem(scrollKey);
        if (savedScroll !== null) {
            sessionStorage.removeItem(scrollKey);
            window.scrollTo(0, parseInt(savedScroll, 10));
        }

        // Save scroll position when clicking tab links
        document.querySelectorAll('.tabs [role="tab"]').forEach(tab => {
            tab.addEventListener('click', () => {
                sessionStorage.setItem(scrollKey, window.scrollY);
            });
        });

        // Tab switching via radio buttons
        document.querySelectorAll('input[name="profile-tabs"]').forEach(radio => {
            radio.addEventListener('change', () => {
                sessionStorage.setItem(scrollKey, window.scrollY);
                window.location.href = `${baseUrl}?tab=${radio.value}`;
            });
        });

        // Infinite scroll for the active tab
        PlatPursuit.InfiniteScroller.create({
            gridId: `${currentTab}-grid`,
            sentinelId: `${currentTab}-sentinel`,
            loadingId: `${currentTab}-loading`,
            paginateBy: 50,
            formSelector: `#${currentTab}-form`,
            scrollKey: 'profileScrollPos'
        });
    });

    PlatPursuit.ZoomScaler.init();
    </script>
{% endblock %}