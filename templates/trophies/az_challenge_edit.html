{% extends 'base.html' %}
{% load static custom_filters %}

{% block title %}Edit: {{ challenge.name }} - Platinum Pursuit{% endblock %}

{% block content %}
<section class="shadow-lg shadow-neutral bg-base-200/80 rounded-box border-2 border-base-300 w-full p-0 lg:p-4">
    {% include 'partials/breadcrumb.html' with items=breadcrumb %}

    <div class="card bg-base-100 border-4 border-base-300 shadow-md shadow-neutral">
        <div class="card-body">
            <div class="flex flex-row items-center justify-between gap-4">
                <div>
                    <h1 class="text-xl lg:text-2xl font-bold">Edit: {{ challenge.name }}</h1>
                    <p class="text-sm text-base-content/70">
                        Click any empty or incomplete slot to assign or swap a game. Completed slots are locked.
                    </p>
                </div>
                <div class="flex gap-2">
                    <a href="{% url 'az_challenge_detail' challenge_id=challenge.id %}" class="btn btn-ghost btn-sm">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 mr-1" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
                        View
                    </a>
                    {% if challenge.filled_count < 26 %}
                        <a href="{% url 'az_challenge_setup' challenge_id=challenge.id %}" class="btn btn-primary btn-sm">
                            Continue Setup
                        </a>
                    {% endif %}
                    <button id="delete-challenge-btn" class="btn btn-ghost btn-sm text-error hover:bg-error/10" data-challenge-id="{{ challenge.id }}">Delete</button>
                </div>
            </div>

            {# Progress #}
            <div class="mt-3">
                <div class="flex justify-between text-sm mb-1">
                    <span>{{ challenge.completed_count }}/26 Platinums</span>
                    <span class="text-base-content/60">{{ challenge.filled_count }}/26 filled</span>
                </div>
                <progress class="progress progress-primary w-full h-2"
                          value="{{ challenge.completed_count }}" max="26"></progress>
            </div>
        </div>
    </div>
</section>

{# 26-Slot Grid (editable) #}
<section class="shadow-lg shadow-neutral bg-base-200/80 rounded-box border-2 border-base-300 w-full p-0 lg:p-4 mt-6">
    <div class="p-4">
        <div id="az-edit-grid" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 xl:grid-cols-7 gap-3">
            {% for slot in slots %}
            <div class="relative group" data-letter="{{ slot.letter }}" data-slot-id="{{ slot.id }}">
                {% include 'partials/az_challenge/slot_card.html' with slot=slot %}

                {# Cover indicator badge #}
                {% if slot.letter == challenge.cover_letter %}
                <div class="absolute top-1 left-1 z-10 cover-indicator" data-letter="{{ slot.letter }}">
                    <div class="badge badge-primary badge-sm gap-0.5" title="Cover image">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-3 h-3" viewBox="0 0 24 24" fill="currentColor"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/></svg>
                    </div>
                </div>
                {% endif %}

                {# Edit overlay (only for non-completed slots) #}
                {% if not slot.is_completed %}
                <div class="absolute inset-0 bg-base-300/80 opacity-0 group-hover:opacity-100 transition-opacity rounded-box flex flex-col items-center justify-center gap-1 cursor-pointer"
                     data-action="edit" data-letter="{{ slot.letter }}">
                    {% if slot.game %}
                        <div class="flex gap-1">
                            <button class="btn btn-xs btn-primary" data-action="swap" data-letter="{{ slot.letter }}">Swap</button>
                            <button class="btn btn-xs btn-error btn-outline" data-action="clear" data-letter="{{ slot.letter }}">Clear</button>
                        </div>
                        {% if slot.letter != challenge.cover_letter %}
                        <button class="btn btn-xs btn-ghost text-base-content/70" data-action="set-cover" data-letter="{{ slot.letter }}">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-3 h-3" viewBox="0 0 24 24" fill="currentColor"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/></svg>
                            Set as Cover
                        </button>
                        {% endif %}
                    {% else %}
                        <button class="btn btn-xs btn-primary" data-action="assign" data-letter="{{ slot.letter }}">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-3 h-3 mr-0.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg>
                            Assign
                        </button>
                    {% endif %}
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>
</section>

{# Search Modal #}
<dialog id="az-search-modal" class="modal">
    <div class="modal-box max-w-2xl">
        <form method="dialog">
            <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">X</button>
        </form>
        <h3 class="text-lg font-bold">
            Pick a game for <span id="modal-letter" class="text-primary text-2xl font-black">A</span>
        </h3>
        <p class="text-xs text-base-content/50 mt-1">
            Double-check the platform and region. Only the exact version you pick counts!
        </p>
        <div class="bg-base-200 rounded-lg p-2.5 text-xs text-base-content/60 space-y-1 mt-2">
            <p class="font-semibold text-base-content/70">Challenge Rules</p>
            <ul class="list-disc list-inside space-y-0.5">
                <li>No stacking: games you've platted and all related versions are excluded</li>
                <li>No shovelware: only quality games allowed</li>
                <li>No games with over 50% completion. Pick something fresh!</li>
                <li>Must have a platinum trophy</li>
            </ul>
        </div>

        {# Chip filters #}
        <div class="flex flex-wrap items-center gap-2 mt-3 mb-2" id="modal-filter-row">
            <span class="text-xs text-base-content/50 font-semibold uppercase tracking-wider mr-1">Filters</span>
            <div class="flex flex-wrap gap-1">
                <button type="button" class="badge badge-ghost badge-sm font-bold cursor-pointer hover:badge-outline transition-all modal-filter-chip" data-filter="platform" data-value="PS5">PS5</button>
                <button type="button" class="badge badge-ghost badge-sm font-bold cursor-pointer hover:badge-outline transition-all modal-filter-chip" data-filter="platform" data-value="PS4">PS4</button>
                <button type="button" class="badge badge-ghost badge-sm font-bold cursor-pointer hover:badge-outline transition-all modal-filter-chip" data-filter="platform" data-value="PS3">PS3</button>
                <button type="button" class="badge badge-ghost badge-sm font-bold cursor-pointer hover:badge-outline transition-all modal-filter-chip" data-filter="platform" data-value="PSVITA">PSVita</button>
                <button type="button" class="badge badge-ghost badge-sm font-bold cursor-pointer hover:badge-outline transition-all modal-filter-chip" data-filter="platform" data-value="PSVR">PSVR</button>
            </div>
            <span class="text-base-content/20">|</span>
            <div class="flex flex-wrap gap-1">
                <button type="button" class="badge badge-ghost badge-sm font-bold cursor-pointer hover:badge-outline transition-all modal-filter-chip" data-filter="region" data-value="global">Global</button>
                <button type="button" class="badge badge-ghost badge-sm font-bold cursor-pointer hover:badge-outline transition-all modal-filter-chip" data-filter="region" data-value="NA">NA</button>
                <button type="button" class="badge badge-ghost badge-sm font-bold cursor-pointer hover:badge-outline transition-all modal-filter-chip" data-filter="region" data-value="EU">EU</button>
                <button type="button" class="badge badge-ghost badge-sm font-bold cursor-pointer hover:badge-outline transition-all modal-filter-chip" data-filter="region" data-value="JP">JP</button>
                <button type="button" class="badge badge-ghost badge-sm font-bold cursor-pointer hover:badge-outline transition-all modal-filter-chip" data-filter="region" data-value="AS">AS</button>
            </div>
            <button type="button" class="btn btn-ghost btn-xs text-error/70 hover:text-error hidden" id="modal-clear-filters">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/>
                </svg>
                Clear
            </button>
        </div>

        {# Search input + Sort #}
        <div class="flex flex-col md:flex-row gap-2 mt-2">
            <input id="modal-search-input" type="text"
                   placeholder="Search within this letter..."
                   class="input input-bordered flex-1 input-sm" />
            <select id="modal-sort-select" class="select select-bordered w-auto select-sm">
                <option value="popular">Most Popular</option>
                <option value="alpha">Alphabetical</option>
                <option value="plat_earners">Most Plats Earned</option>
            </select>
        </div>

        {# Results â€” single column, scrollable #}
        <div id="modal-search-results" class="flex flex-col gap-2 mt-4 max-h-96 overflow-y-auto">
            {# Infinite scroll sentinel (inside scrollable container) #}
            <div id="modal-scroll-sentinel" class="hidden text-center py-4">
                <span class="loading loading-spinner loading-md text-primary"></span>
            </div>
        </div>
        <div id="modal-search-loading" class="hidden text-center py-4">
            <span class="loading loading-spinner loading-md text-primary"></span>
        </div>
        <div id="modal-no-results" class="hidden text-center py-4 text-base-content/50">
            No games found.
        </div>
    </div>
    <form method="dialog" class="modal-backdrop"><button>close</button></form>
</dialog>
{% endblock %}

{% block js_scripts %}
<script>PlatPursuit.ZoomScaler.init();</script>
<script src="{% static 'js/az-challenge.js' %}"></script>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        if (typeof AZChallengeEdit !== 'undefined') {
            AZChallengeEdit.init({{ challenge.id }}, {{ slots_json|safe }}, '{{ challenge.cover_letter }}');
        }
    });
</script>
{% endblock %}
