{% extends 'base.html' %}
{% load static custom_filters %}

{% block title %}My Challenges - Platinum Pursuit{% endblock %}

{% block content %}
<section class="shadow-lg shadow-neutral bg-base-200/80 rounded-box border-2 border-base-300 w-full p-0 lg:p-4">
    {% include 'partials/breadcrumb.html' with items=breadcrumb %}

    <div class="card bg-base-100 border-4 border-base-300 shadow-md shadow-neutral">
        <div class="card-body">
            <div class="flex flex-row items-center justify-between gap-4">
                <div>
                    <h1 class="text-2xl lg:text-3xl font-bold">My Challenges</h1>
                    <p class="text-base-content/70">Track your progress and manage your challenges.</p>
                </div>
                <a href="{% url 'challenges_browse' %}" class="btn btn-ghost btn-md">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 mr-1" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="11" cy="11" r="8"></circle>
                        <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                    </svg>
                    Browse All
                </a>
            </div>
        </div>
    </div>
</section>

{# ─── A-Z Platinum Challenge Section ─────────────────────────────────── #}
<section class="shadow-lg shadow-neutral bg-base-200/80 rounded-box border-2 border-base-300 w-full p-0 lg:p-4 mt-6">
    <div class="p-4">
        <h2 class="text-lg font-bold mb-3">
            <span class="text-primary">A-Z Platinum Challenge</span>
        </h2>

        {% if active_az %}
            <div class="card bg-base-100 border-2 border-primary/30 shadow-md">
                <div class="card-body p-4">
                    <div class="flex flex-row items-center justify-between gap-4">
                        <div class="flex-1">
                            <h3 class="text-xl font-bold">{{ active_az.name }}</h3>
                            <div class="flex items-center gap-3 mt-1 text-sm text-base-content/60">
                                <span>{{ active_az.completed_count }}/26 Platinums</span>
                                <span>{{ active_az.filled_count }}/26 Slots Filled</span>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            {% if active_az.filled_count < 26 %}
                                <a href="{% url 'az_challenge_setup' challenge_id=active_az.id %}" class="btn btn-primary btn-sm">
                                    Continue Setup
                                </a>
                            {% endif %}
                            <a href="{% url 'az_challenge_detail' challenge_id=active_az.id %}" class="btn btn-ghost btn-sm">View</a>
                            <a href="{% url 'az_challenge_edit' challenge_id=active_az.id %}" class="btn btn-ghost btn-sm">Edit</a>
                            <button id="delete-challenge-btn" class="btn btn-ghost btn-sm text-error hover:bg-error/10" data-challenge-id="{{ active_az.id }}">Delete</button>
                        </div>
                    </div>

                    {# Progress bar #}
                    <div class="mt-3">
                        <progress class="progress progress-primary w-full h-3"
                                  value="{{ active_az.completed_count }}"
                                  max="26"></progress>
                    </div>

                    {# Mini slot preview #}
                    <div class="flex flex-wrap gap-1 mt-3">
                        {% for slot in active_az.az_slots.all %}
                            <div class="w-7 h-7 lg:w-8 lg:h-8 rounded text-xs font-bold flex items-center justify-center
                                        {% if slot.is_completed %}bg-success text-success-content
                                        {% elif slot.game %}bg-primary/20 text-primary
                                        {% else %}bg-base-200 text-base-content/30{% endif %}">
                                {{ slot.letter }}
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        {% elif can_create_az %}
            <div class="card bg-base-100 border-2 border-dashed border-base-300">
                <div class="card-body items-center text-center py-8">
                    <p class="text-4xl mb-2">&#127775;</p>
                    <p class="text-lg font-bold text-base-content/70">The alphabet awaits, hunter.</p>
                    <p class="text-sm text-base-content/50 mb-4">26 letters, 26 platinums, infinite glory.</p>
                    <a href="{% url 'az_challenge_create' %}" class="btn btn-primary">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 mr-1" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg>
                        Start A-Z Challenge
                    </a>
                </div>
            </div>
        {% endif %}
    </div>
</section>

{# ─── Platinum Calendar Section ──────────────────────────────────────── #}
<section class="shadow-lg shadow-neutral bg-base-200/80 rounded-box border-2 border-base-300 w-full p-0 lg:p-4 mt-6">
    <div class="p-4">
        <h2 class="text-lg font-bold mb-3">
            <span class="text-primary">Platinum Calendar</span>
        </h2>

        {% if active_calendar %}
            <div class="card bg-base-100 border-2 border-primary/30 shadow-md">
                <div class="card-body p-4">
                    <div class="flex flex-row items-center justify-between gap-4">
                        <div class="flex-1">
                            <h3 class="text-xl font-bold">{{ active_calendar.name }}</h3>
                            <div class="flex items-center gap-3 mt-1 text-sm text-base-content/60">
                                <span>{{ active_calendar.completed_count }}/365 Days Filled</span>
                                <span>{{ active_calendar.progress_percentage }}%</span>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <a href="{% url 'calendar_challenge_detail' challenge_id=active_calendar.id %}" class="btn btn-primary btn-sm">View</a>
                            <button id="delete-calendar-btn" class="btn btn-ghost btn-sm text-error hover:bg-error/10" data-challenge-id="{{ active_calendar.id }}">Delete</button>
                        </div>
                    </div>

                    {# Progress bar #}
                    <div class="mt-3">
                        <progress class="progress progress-primary w-full h-3"
                                  value="{{ active_calendar.completed_count }}"
                                  max="365"></progress>
                    </div>

                    {# Mini calendar month grid #}
                    {% if active_calendar_months %}
                    <div class="grid grid-cols-6 lg:grid-cols-12 gap-2 mt-3">
                        {% for month in active_calendar_months %}
                        <div class="flex flex-col items-center py-1.5 rounded-md {% if month.filled_count == month.total_days %}bg-warning/10 ring-1 ring-warning/30{% endif %}">
                            <div class="text-xs font-bold {% if month.filled_count == month.total_days %}text-warning{% elif month.filled_count > 0 %}text-base-content/70{% else %}text-base-content/30{% endif %}">{{ month.month_abbr }}</div>
                            <div class="text-[0.65rem] {% if month.filled_count == month.total_days %}text-warning/80{% elif month.filled_count > 0 %}text-success{% else %}text-base-content/20{% endif %} font-medium">{{ month.filled_count }}/{{ month.total_days }}</div>
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
            </div>
        {% elif can_create_calendar %}
            <div class="card bg-base-100 border-2 border-dashed border-base-300">
                <div class="card-body items-center text-center py-8">
                    <p class="text-4xl mb-2">&#128197;</p>
                    <p class="text-lg font-bold text-base-content/70">365 days, 365 platinums.</p>
                    <p class="text-sm text-base-content/50 mb-4">Can you fill the entire year? Sign up and we'll do the rest.</p>
                    <a href="{% url 'calendar_challenge_create' %}" class="btn btn-primary">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 mr-1" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                            <line x1="16" y1="2" x2="16" y2="6"></line>
                            <line x1="8" y1="2" x2="8" y2="6"></line>
                            <line x1="3" y1="10" x2="21" y2="10"></line>
                        </svg>
                        Start Platinum Calendar
                    </a>
                </div>
            </div>
        {% endif %}
    </div>
</section>

{# ─── History Section ────────────────────────────────────────────────── #}
{% if history %}
<section class="shadow-lg shadow-neutral bg-base-200/80 rounded-box border-2 border-base-300 w-full p-0 lg:p-4 mt-6">
    <div class="p-4">
        <h2 class="text-lg font-bold mb-3">Challenge History</h2>
        <div class="grid grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
            {% for challenge in history %}
                {% if challenge.challenge_type == 'calendar' %}
                    {% include 'partials/calendar_challenge/challenge_card.html' with challenge=challenge %}
                {% else %}
                    {% include 'partials/az_challenge/challenge_card.html' with challenge=challenge %}
                {% endif %}
            {% endfor %}
        </div>
    </div>
</section>
{% endif %}

{# ─── Calendar Delete Confirmation Modal ──────────────────────────────── #}
{% if active_calendar %}
<dialog id="calendar-delete-modal" class="modal">
    <div class="modal-box">
        <h3 class="font-bold text-lg">Delete Calendar Challenge?</h3>
        <p class="py-4 text-base-content/70">This will permanently delete your Platinum Calendar. Your trophy data is not affected.</p>
        <div class="modal-action">
            <form method="dialog">
                <button class="btn btn-ghost">Cancel</button>
            </form>
            <button id="calendar-delete-confirm" class="btn btn-error">Delete</button>
        </div>
    </div>
    <form method="dialog" class="modal-backdrop"><button>close</button></form>
</dialog>
{% endif %}
{% endblock %}

{% block js_scripts %}
<script>PlatPursuit.ZoomScaler.init();</script>
<script src="{% static 'js/az-challenge.js' %}"></script>
{% if active_calendar %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const btn = document.getElementById('delete-calendar-btn');
        const modal = document.getElementById('calendar-delete-modal');
        const confirm = document.getElementById('calendar-delete-confirm');
        if (!btn || !modal || !confirm) return;

        btn.addEventListener('click', () => modal.showModal());
        confirm.addEventListener('click', async () => {
            try {
                await PlatPursuit.API.delete(`/api/v1/challenges/calendar/${btn.dataset.challengeId}/delete/`);
                modal.close();
                PlatPursuit.ToastManager.success('Calendar challenge deleted.');
                window.location.reload();
            } catch (error) {
                modal.close();
                let msg = 'Failed to delete challenge.';
                try { const errData = await error.response?.json(); msg = errData?.error || msg; } catch {}
                PlatPursuit.ToastManager.error(msg);
            }
        });
    });
</script>
{% endif %}
{% endblock %}
