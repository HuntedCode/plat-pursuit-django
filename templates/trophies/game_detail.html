{% extends 'base.html' %}
{% load custom_filters humanize static %}
{% block title %}{{ game.title_name }}{% endblock %}

{% block content %}
    <section class="shadow-lg shadow-neutral bg-base-200/80 rounded-box border-2 border-base-300 w-full p-0 lg:p-4">
        {% include 'partials/breadcrumb.html' with items=breadcrumb %}
        {% include 'trophies/partials/game_detail/game_detail_header.html' %}
    </section>

    <div class="flex flex-col xl:flex-row gap-4 mt-8 items-start">
        {% if game.concept.guide_slug %}
            <section class="shadow-lg shadow-neutral bg-base-200/80 rounded-box border-2 border-base-300 w-full xl:w-1/3 p-0 lg:p-4 ">
                {% include 'trophies/partials/game_detail/community_ratings.html' %}
            </section>

            <section class="shadow-lg shadow-neutral bg-base-200/80 rounded-box border-2 border-base-300 w-full xl:w-2/3 p-0 lg:p-4 xl:sticky xl:top-2">
                {% include 'trophies/partials/game_detail/guide_embed.html' %}
            </section>
        {% else %}
            <section class="flex flex-col lg:flex-row shadow-lg shadow-neutral bg-base-200/80 rounded-box border-2 border-base-300 w-auto p-4 mx-auto gap-4 items-center lg:items-start">
                {% include 'trophies/partials/game_detail/community_ratings.html' %}
            </section>
        {% endif %}
    </div>

    {% if trophies_syncing %}
        <section class="shadow-lg shadow-neutral bg-base-200/80 rounded-box border-2 border-base-300 w-full p-0 lg:p-4 mt-8">
            <div class="alert alert-info mb-4">
            <span class="loading loading-spinner"></span>
            Trophies are syncingâ€”check back in a few moments for full details!
        </div>
        </section>
    {% else %}
        <section class="shadow-lg shadow-neutral bg-base-200/80 rounded-box border-2 border-base-300 w-full p-0 lg:p-4 mt-8 mx-auto">
            <div class="card bg-base-100 border-4 border-base-300 shadow-md shadow-neutral">
                <div class="card-body px-4 py-2">
                    <form id="filter-form" method="get" class="mb-4">
                        <div class="flex flex-col lg:flex-row w-7/8 justify-between mx-auto">
                            <div class="form-control fieldset w-full lg:w-1/2">
                                <legend class="fieldset-legend text-lg lg:text-xl italic">Sort By</legend>
                                <select name="sort" id="id_sort" class="select select-primary w-7/8 justify-self-center">
                                    {% for value, display in form.sort.field.choices %}
                                        <option value="{{ value }}" {% if request.GET.sort == value %}selected{% endif %}>{{ display }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="form-control fieldset w-full lg:w-1/2">
                                <legend class="fieldset-legend text-lg lg:text-xl italic">Earned Status</legend>
                                <select name="earned" id="id_earned" class="select select-primary w-7/8 justify-self-center">
                                    {% for value, display in form.earned.field.choices %}
                                        <option value="{{ value }}" {% if request.GET.earned == value %}selected{% endif %}>{{ display }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <button id="submit-btn" type="submit" class="btn btn-md md:btn-lg border-3 shadow-md place-self-end mt-4 lg:mt-0" disabled>Feel The Power...</button>
                        </div>
                    </form>
                </div>
            </div>
        </section>
        {% for group_id, trophies in grouped_trophies.items %}
            {% with trophy_groups|dict_get:group_id as group %}
                {% with profile_group_totals|dict_get:group_id as profile_group_total %}
                    <section class="shadow-lg shadow-neutral bg-base-200/80 rounded-box border-2 border-base-300 w-full p-0 lg:p-4 mt-8">
                        {% include 'trophies/partials/game_detail/trophy_group_card.html' %}
                        {% include 'trophies/partials/game_detail/trophy_list.html' %}
                    </section>
                {% endwith %}
            {% endwith %}
        {% endfor %}
    {% endif %}
{% endblock %}

{% block js_scripts %}
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const carouselNavLinks = document.querySelectorAll('[data-slide-to]');
            const carousel = document.getElementById('screenshot-carousel')

            carouselNavLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();

                    const targetId = e.currentTarget.dataset.slideTo;
                    const targetSlide = document.getElementById(targetId);

                    if (targetSlide) {
                        carousel.scrollTo({
                            left: targetSlide.offsetLeft,
                            behavior: 'smooth'
                        })
                    }
                });
            });
        });

        const scrollKey = 'profileScrollPos';
        form = document.getElementById('filter-form');
        unearnedToggle = document.getElementById('unearned-toggle')
        if (form) {
            form.addEventListener('submit', () => {
                localStorage.setItem(scrollKey, window.scrollY);
                page = 2;
                nextPageUrl = `${baseUrl}?page=${page}&${queryParams.toString()}`;
            });
        }

        if (unearnedToggle) {
            unearnedToggle.addEventListener('submit', () => {
                localStorage.setItem(scrollKey, window.scrollY);
                page = 2;
                nextPageUrl = `${baseUrl}?page=${page}&${queryParams.toString()}`;
            });
        }

        const savedScroll = localStorage.getItem(scrollKey);
        if (savedScroll) {
            window.scrollTo({
                top: parseInt(savedScroll),
                behavior: 'smooth'
            });
            localStorage.removeItem(scrollKey);
        }
    </script>
    <script src="{% static 'js\submit_shimmer.js' %}"></script>
{% endblock %}