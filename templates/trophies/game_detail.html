{% extends 'base.html' %}
{% load custom_filters humanize static %}
{% block title %}{{ game.title_name }}{% endblock %}

{% block content %}
    <div id="game-detail-container"
         data-base-url="{% url 'game_detail' game.np_communication_id %}"
         data-scroll-key="gameDetailScrollPos_{{ game.np_communication_id }}">
        <section class="section-container w-full">
            {% include 'partials/breadcrumb.html' with items=breadcrumb %}
            {% include 'trophies/partials/game_detail/game_detail_header.html' %}
        </section>

    <div class="flex flex-col xl:flex-row gap-4 mt-8 items-start">
        {% if game.concept.guide_slug %}
            <section class="section-container w-full xl:w-1/3">
                {% include 'trophies/partials/game_detail/community_ratings.html' %}
            </section>

            <section class="section-container w-full xl:w-2/3 xl:sticky xl:top-2">
                {% include 'trophies/partials/game_detail/guide_embed.html' %}
            </section>
        {% else %}
            <section class="flex flex-col lg:flex-row section-container w-auto !p-4 mx-auto gap-4 items-center lg:items-start">
                {% include 'trophies/partials/game_detail/community_ratings.html' %}
            </section>
        {% endif %}
    </div>

    <!-- Comment Section -->
    {% if game.concept %}
        {% include 'trophies/partials/game_detail/comment_section.html' %}
    {% endif %}

    <!-- Checklist Section -->
    {% if game.concept %}
        {% include 'trophies/partials/game_detail/checklist_section.html' %}
    {% endif %}

    {% if trophies_syncing %}
        <section class="section-container w-full mt-8">
            <div class="alert alert-info mb-4" role="status" aria-live="polite">
                <span class="loading loading-spinner" aria-hidden="true"></span>
                Trophies are syncingâ€”check back in a few moments for full details!
            </div>
        </section>
    {% else %}
        <section class="section-container w-full mt-8 mx-auto">
            <div class="card bg-base-100 border-4 border-base-300 shadow-md shadow-neutral">
                <div class="card-body px-4 py-2">
                    <form id="filter-form" method="get" class="mb-4">
                        <fieldset>
                            <legend class="sr-only">Filter and Sort Trophies</legend>
                            <div class="flex flex-col lg:flex-row w-7/8 justify-between mx-auto">
                                <div class="form-control w-full lg:w-1/2">
                                    <label for="id_sort" class="label">
                                        <span class="label-text text-lg lg:text-xl italic">Sort By</span>
                                    </label>
                                    <select name="sort" id="id_sort" class="select select-primary w-7/8 justify-self-center">
                                        {% for value, display in form.sort.field.choices %}
                                            <option value="{{ value }}" {% if request.GET.sort == value %}selected{% endif %}>{{ display }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="form-control w-full lg:w-1/2">
                                    <label for="id_earned" class="label">
                                        <span class="label-text text-lg lg:text-xl italic">Earned Status</span>
                                    </label>
                                    <select name="earned" id="id_earned" class="select select-primary w-7/8 justify-self-center">
                                        {% for value, display in form.earned.field.choices %}
                                            <option value="{{ value }}" {% if request.GET.earned == value %}selected{% endif %}>{{ display }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <button id="submit-btn" type="submit" class="btn btn-md md:btn-lg border-3 shadow-md place-self-end mt-4 lg:mt-0" aria-label="Apply trophy filters" disabled>Feel The Power...</button>
                            </div>
                        </fieldset>
                    </form>
                </div>
            </div>
        </section>
        {% for group_id, trophies in grouped_trophies.items %}
            {% with trophy_groups|dict_get:group_id as group %}
                {% with profile_group_totals|dict_get:group_id as profile_group_total %}
                    <section class="section-container w-full mt-8">
                        {% include 'trophies/partials/game_detail/trophy_group_card.html' %}
                        {% include 'trophies/partials/game_detail/trophy_list.html' %}
                    </section>
                {% endwith %}
            {% endwith %}
        {% endfor %}
    {% endif %}
    </div>
{% endblock %}

{% block js_scripts %}
    <script src="{% static 'js/game-detail.js' %}"></script>
    <script src="{% static 'js/submit_shimmer.js' %}"></script>
    <script src="{% static 'js/comments.js' %}"></script>
    <script src="{% static 'js/trophy-comments.js' %}"></script>
    <script src="{% static 'js/checklist.js' %}"></script>
{% endblock %}