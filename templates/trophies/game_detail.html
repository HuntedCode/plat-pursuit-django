{% extends 'base.html' %}
{% load custom_filters humanize static %}
{% block title %}{{ game.title_name }}{% endblock %}
{% block og_image %}{% if game.image_url %}{{ game.image_url }}{% else %}{{ request.scheme }}://{{ request.get_host }}{{ logo_path }}{% endif %}{% endblock %}
{% block twitter_image %}{% if game.image_url %}{{ game.image_url }}{% else %}{{ request.scheme }}://{{ request.get_host }}{{ logo_path }}{% endif %}{% endblock %}

{% block content %}
    <div id="game-detail-container"
         data-base-url="{% url 'game_detail' game.np_communication_id %}"
         data-scroll-key="gameDetailScrollPos_{{ game.np_communication_id }}">
        <section class="section-container w-full">
            {% include 'partials/breadcrumb.html' with items=breadcrumb view_count=view_count %}
            {% include 'trophies/partials/game_detail/game_detail_header.html' %}

            {% if user.is_authenticated and user.profile %}
            <div class="mt-4 flex justify-end gap-2">
                {% if earned_trophy_id %}
                <button id="share-card-btn"
                        class="btn btn-sm btn-outline btn-secondary"
                        aria-label="Create Share Card"
                        data-earned-trophy-id="{{ earned_trophy_id }}"
                        data-game-name="{{ game.title_name }}"
                        data-game-image="{{ game.title_image|default:game.title_icon_url|default:'' }}"
                        data-concept-bg-url="{{ concept_bg_url }}">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"/>
                    </svg>
                    Share Card
                </button>
                {% endif %}
                <div class="relative" id="quick-add-container" data-game-id="{{ game.id }}">
                    <button class="btn btn-sm btn-outline btn-info quick-add-trigger" aria-label="Add to List">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="8" y1="6" x2="21" y2="6"></line>
                            <line x1="8" y1="12" x2="21" y2="12"></line>
                            <line x1="8" y1="18" x2="21" y2="18"></line>
                            <line x1="3" y1="6" x2="3.01" y2="6"></line>
                            <line x1="3" y1="12" x2="3.01" y2="12"></line>
                            <line x1="3" y1="18" x2="3.01" y2="18"></line>
                        </svg>
                        Add to List
                    </button>
                </div>
            </div>
            {% endif %}
        </section>

    <div class="flex flex-col xl:flex-row gap-4 mt-8 items-start">
        {% if game.concept.guide_slug %}
            <section class="section-container w-full xl:w-1/3">
                {% include 'trophies/partials/game_detail/community_ratings.html' %}
            </section>

            <section class="section-container w-full xl:w-2/3 xl:sticky xl:top-2">
                {% include 'trophies/partials/game_detail/guide_embed.html' %}
            </section>
        {% else %}
            <section class="flex flex-col lg:flex-row section-container w-auto !p-4 mx-auto gap-4 items-center lg:items-start">
                {% include 'trophies/partials/game_detail/community_ratings.html' %}
            </section>
        {% endif %}
    </div>

    {% include 'partials/ad_unit.html' with ad_slot="8393162469" %}

    <!-- Comment Section -->
    {% if game.concept %}
        {% include 'trophies/partials/game_detail/comment_section.html' %}
    {% endif %}

    <!-- Checklist Section -->
    {% if game.concept %}
        {% include 'trophies/partials/game_detail/checklist_section.html' %}
    {% endif %}

    {% if trophies_syncing %}
        <section class="section-container w-full mt-8">
            <div class="alert alert-info mb-4" role="status" aria-live="polite">
                <span class="loading loading-spinner" aria-hidden="true"></span>
                Trophies are syncingâ€”check back in a few moments for full details!
            </div>
        </section>
    {% else %}
        <section class="section-container w-full mt-8 mx-auto">
            <div class="card bg-base-100 border-2 border-base-300 shadow-sm shadow-neutral">
                <div class="card-body px-4 py-2">
                    <form id="filter-form" method="get" class="mb-4">
                        <fieldset>
                            <legend class="sr-only">Filter and Sort Trophies</legend>
                            <div class="grid grid-cols-[1fr_1fr_auto] gap-4 items-end mx-auto">
                                <div class="form-control w-full">
                                    <label for="id_sort" class="label">
                                        <span class="label-text text-base lg:text-lg italic">Sort By</span>
                                    </label>
                                    <select name="sort" id="id_sort" class="select select-primary w-full">
                                        {% for value, display in form.sort.field.choices %}
                                            <option value="{{ value }}" {% if request.GET.sort == value %}selected{% endif %}>{{ display }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="form-control w-full">
                                    <label for="id_earned" class="label">
                                        <span class="label-text text-base lg:text-lg italic">Earned Status</span>
                                    </label>
                                    <select name="earned" id="id_earned" class="select select-primary w-full">
                                        {% for value, display in form.earned.field.choices %}
                                            <option value="{{ value }}" {% if request.GET.earned == value %}selected{% endif %}>{{ display }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <button id="submit-btn" type="submit" class="btn btn-md md:btn-lg border-3 shadow-md w-full lg:w-auto" aria-label="Apply trophy filters" disabled>Feel The Power...</button>
                            </div>
                        </fieldset>
                    </form>
                </div>
            </div>
        </section>
        {% if game.has_trophy_groups %}
            <section class="section-container w-full mt-4">
                <div class="card bg-base-100 border-2 border-base-300 shadow-sm shadow-neutral">
                    <div class="card-body px-4 py-2">
                        <h3 class="text-sm font-semibold text-base-content/70 italic mb-1">Trophy Groups</h3>
                        <div class="flex flex-row gap-2 overflow-x-auto pb-1">
                            {% for group_id, trophies in grouped_trophies.items %}
                                {% with trophy_groups|dict_get:group_id as group %}
                                    <a href="#trophy-group-{{ group_id }}"
                                       class="btn btn-sm btn-ghost border border-base-300 flex-shrink-0 gap-1.5 hover:border-primary hover:shadow-sm"
                                       onclick="event.preventDefault(); document.getElementById('trophy-group-{{ group_id }}').scrollIntoView({behavior:'smooth', block:'start'})">
                                        <img src="{{ group.trophy_group_icon_url }}" class="w-5 h-5 rounded object-cover" alt="" />
                                        <span class="text-xs whitespace-nowrap">{{ group.trophy_group_name }}</span>
                                        <span class="badge badge-xs badge-ghost">{{ trophies|length }}</span>
                                    </a>
                                {% endwith %}
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </section>
        {% endif %}
        {% for group_id, trophies in grouped_trophies.items %}
            {% with trophy_groups|dict_get:group_id as group %}
                {% with profile_group_totals|dict_get:group_id as profile_group_total %}
                    <section id="trophy-group-{{ group_id }}" class="section-container w-full mt-8">
                        {% include 'trophies/partials/game_detail/trophy_group_card.html' %}
                        {% include 'trophies/partials/game_detail/trophy_list.html' %}
                    </section>
                {% endwith %}
            {% endwith %}
        {% endfor %}
    {% endif %}
    </div>

{% if earned_trophy_id %}
{# Share Card Modal #}
<dialog id="share-modal" class="modal">
    <div class="modal-box max-w-4xl bg-base-200">
        <form method="dialog">
            <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </form>
        <h3 class="font-bold text-lg mb-4" id="share-modal-title">Create Share Image</h3>
        <div id="share-modal-content">
            <div class="flex justify-center items-center py-12">
                <span class="loading loading-spinner loading-lg"></span>
            </div>
        </div>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button>close</button>
    </form>
</dialog>

{# Color Grid Modal - for background selection #}
{% include 'partials/color_grid_modal.html' with available_themes=available_themes %}
{% endif %}

{% endblock %}

{% block js_scripts %}
    <script>PlatPursuit.ZoomScaler.init();</script>
    <script src="{% static 'js/game-detail.js' %}"></script>
    <script src="{% static 'js/game-players-modal.js' %}"></script>
    <script src="{% static 'js/submit_shimmer.js' %}"></script>
    <script src="{% static 'js/comments.js' %}"></script>
    <script src="{% static 'js/checklist.js' %}"></script>
    {% if earned_trophy_id %}
    <script>window.GRADIENT_THEMES = {% gradient_themes_json %};</script>
    <script src="{% static 'js/share-image.js' %}"></script>
    <script src="{% static 'js/color-grid-modal.js' %}"></script>
    <script src="{% static 'js/shareable-manager.js' %}"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const shareBtn = document.getElementById('share-card-btn');
            if (shareBtn) {
                shareBtn.addEventListener('click', () => openShareModal(shareBtn));
            }
        });
    </script>
    {% endif %}
    {% if user.is_authenticated and user.profile %}
    <script src="{% static 'js/game-lists.js' %}"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => GameListQuickAdd.init());
    </script>
    {% endif %}
{% endblock %}