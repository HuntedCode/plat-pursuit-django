{% load custom_filters %}
{% load static %}
{% load humanize %}
<div id="hotbar-wrapper" class="sticky top-2 z-40 xl:w-3/4 mx-auto transition-all duration-300 ease-in-out">
    <div id="hotbar-container"
         class="hotbar-loading bg-base-200/95 backdrop-blur-md border-2 border-primary rounded-box shadow-lg shadow-primary/25 w-full overflow-hidden transition-all duration-300 ease-in-out"
         data-url-sync="{% url 'profile_sync_status' %}"
         data-url-trigger="{% url 'trigger_sync' %}"
         data-url-add-sync="{% url 'add_sync_status' %}"
         data-csrf="{{ csrf_token }}"
         data-sync-status="{{ hotbar.sync_status }}"
         data-seconds="{{ hotbar.seconds_to_next_sync }}">
        <div class="px-3 py-2 xl:px-6 xl:py-2">
            <div class="flex flex-row items-center justify-between gap-2 xl:gap-4">
                <!-- Left: Profile info -->
                <div class="flex flex-row items-center gap-2 xl:gap-3 min-w-0">
                    {% if hotbar.profile %}
                        <a href="{% url 'profile_detail' hotbar.profile.psn_username %}" class="avatar shrink-0">
                            <div class="w-5 sm:w-7 xl:w-8 rounded-full ring-1 sm:ring-2 ring-primary hover:scale-105 transition-transform">
                                <img src="{{ hotbar.profile.avatar_url|default:'/static/default-avatar.png' }}" alt="Profile Avatar" />
                            </div>
                        </a>
                        <a href="{% url 'profile_detail' hotbar.profile.psn_username %}" class="flex items-center gap-2 min-w-0">
                            <span id="sync-user" class="text-xs xl:text-sm font-bold truncate">{{ hotbar.profile.display_psn_username }}</span>
                            <div aria-live="polite" aria-atomic="true" class="sr-only" id="sync-status-announcement"></div>
                            <span id="sync-badge" class="badge badge-xs xl:badge-sm {% if hotbar.sync_status == 'synced' %}badge-success{% elif hotbar.sync_status == 'syncing' %}badge-warning{% else %}badge-error{% endif %} font-bold shrink-0" role="status">{{ hotbar.sync_status|sync_status_display }}</span>
                        </a>
                        <div id="sync-progress-div" class="flex items-center gap-1 {% if not hotbar.sync_status == 'syncing' %}hidden{% endif %}">
                            <progress id="sync-progress-bar" class="progress progress-primary w-16 xl:w-24 h-2" value="{{ hotbar.progress_percentage|floatformat:0|default:0 }}" max="100"></progress>
                            <span id="sync-progress-percent" class="text-xs text-base-content/70">{{ hotbar.progress_percentage|floatformat:0|default:0 }}%</span>
                            <span class="loading loading-spinner loading-sm"></span>
                        </div>
                        <button id="sync-now-btn"
                                class="btn btn-primary btn-xs border border-base-300 shrink-0 {% if hotbar.sync_status == 'syncing' %}hidden{% endif %}"
                                aria-label="{% if hotbar.seconds_to_next_sync > 0 %}Sync available soon{% else %}Sync profile now{% endif %}"
                                {% if hotbar.seconds_to_next_sync > 0 %}disabled{% endif %}></button>
                    {% else %}
                        <p class="text-xs">Link your PSN profile to see status.</p>
                    {% endif %}
                </div>
                {% if hotbar.profile %}
                    <!-- Center: Stats (large screens only) -->
                    <div class="hidden lg:flex items-center gap-3 text-xs text-base-content/70 shrink-0">
                        <span>Synced {{ hotbar.profile.last_synced|naturaltime }}</span>
                        <span class="text-base-content/30">|</span>
                        <span class="text-trophy-platinum font-bold" title="Platinum">{{ hotbar.profile.total_plats }}</span>
                        <span class="text-trophy-gold font-bold" title="Gold">{{ hotbar.profile.total_golds }}</span>
                        <span class="text-trophy-silver font-bold" title="Silver">{{ hotbar.profile.total_silvers }}</span>
                        <span class="text-trophy-bronze font-bold" title="Bronze">{{ hotbar.profile.total_bronzes }}</span>
                    </div>
                {% endif %}
                <!-- Right: Search form (desktop) -->
                <div class="hidden md:flex items-center shrink-0">
                    <form id="sync-form" method="post" action="{% url 'search_sync_profile' %}" class="flex items-center gap-2" data-form-type="other">
                        {% csrf_token %}
                        <input id="add-sync-input" type="search" name="psn_username" placeholder="PSN Username" class="input input-accent input-xs xl:input-sm w-36 xl:w-48" autocomplete="off" data-form-type="other" data-lpignore="true" readonly onfocus="this.removeAttribute('readonly')" required />
                        <button id="add-sync-btn" type="submit" class="btn btn-accent btn-xs border border-base-300" aria-label="Sync new profile">Sync</button>
                        <a href="" id="add-sync-anchor" class="btn btn-success btn-xs border border-base-300 hidden" aria-label="Visit synced profile">Visit</a>
                        <span id="add-sync-load" class="loading loading-spinner loading-sm hidden" role="status" aria-label="Syncing profile"></span>
                    </form>
                </div>
                <!-- Mobile search toggle -->
                <button id="mobile-search-toggle" class="btn btn-ghost btn-xs md:hidden shrink-0" aria-label="Search profiles">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                </button>
            </div>
            <!-- Mobile search row (collapsible) -->
            <div id="mobile-search-row" class="md:hidden overflow-hidden max-h-0 transition-all duration-300 ease-in-out">
                <div class="pt-2 pb-1">
                    <form id="sync-form-mobile" method="post" action="{% url 'search_sync_profile' %}" class="flex items-center gap-2" data-form-type="other">
                        {% csrf_token %}
                        <input type="search" name="psn_username" placeholder="PSN Username" class="input input-accent input-xs flex-1" autocomplete="off" data-form-type="other" data-lpignore="true" readonly onfocus="this.removeAttribute('readonly')" required />
                        <button type="submit" class="btn btn-accent btn-xs border border-base-300">Sync</button>
                    </form>
                </div>
            </div>
            <!-- Error text (shared) -->
            <p id="add-sync-error-text" class="text-xs text-error font-bold italic hidden mt-1"></p>
        </div>
    </div>
    <!-- Toggle button: inside wrapper so it moves with the hotbar -->
    <button id="hotbar-toggle"
            class="hidden xl:block mx-auto bg-base-300 border-2 border-primary border-t-0 rounded-b-lg px-4 py-1 shadow-md shadow-primary/25 cursor-pointer transition-all duration-300 hover:bg-base-200 hover:shadow-primary/40 group"
            aria-label="Toggle hotbar">
        <svg id="toggle-icon" class="w-5 h-5 text-primary rotate-180 transition-transform duration-300 group-hover:scale-110" fill="none" stroke="currentColor" viewBox="0 0 24 24" role="img" aria-labelledby="hotbar-toggle-icon">
            <title id="hotbar-toggle-icon">Toggle hotbar visibility</title>
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M19 9l-7 7-7-7" />
        </svg>
    </button>
</div>

<script src="{% static 'js/hotbar.js' %}"></script>
