{% load static %}
<nav class="navbar bg-base-200 shadow-lg" role="navigation" aria-label="Main navigation">

    <!-- navbar-start: Logo -->
    <div class="navbar-start flex items-center">
        <a href="/" class="btn btn-ghost items-center text-xl font-logo hidden sm:flex" aria-label="Platinum Pursuit Home">
            <img src="{% static 'images/logo.png' %}" alt="Platinum Pursuit Logo" class="h-8 w-8 mr-2 rounded-full" loading="eager" decoding="async" />
            Platinum Pursuit
        </a>
    </div>

    <!-- navbar-center: Mobile logo (sm:hidden) + Desktop mega menus (lg:flex) -->
    <div class="navbar-center flex sm:hidden">
        <a href="/" class="btn btn-ghost flex items-center text-lg font-logo" aria-label="Platinum Pursuit Home">
            <img src="{% static 'images/logo.png' %}" alt="Platinum Pursuit Logo" class="h-8 w-8 mr-2 rounded-full" loading="eager" decoding="async" />
            Plat Pursuit
        </a>
    </div>

    <div class="navbar-center hidden lg:flex">
        <ul class="menu menu-horizontal px-1">
            <!-- Browse -->
            <li>
                <details class="mega-menu-dropdown">
                    <summary>Browse</summary>
                    <ul class="mega-menu-content">
                        <li><a href="{% url 'games_list' %}">Games</a></li>
                        <li><a href="{% url 'profiles_list' %}">Profiles</a></li>
                        <li><a href="{% url 'trophies_list' %}">Trophies</a></li>
                    </ul>
                </details>
            </li>
            <!-- Community -->
            <li>
                <details class="mega-menu-dropdown">
                    <summary>Community</summary>
                    <ul class="mega-menu-content">
                        <li><a href="https://discord.gg/platpursuit" target="_blank" rel="noopener noreferrer">Discord</a></li>
                        <li><a href="{% url 'challenges_browse' %}">Challenges</a></li>
                        <li><a href="{% url 'lists_browse' %}">Game Lists</a></li>
                        <li><a href="{% url 'overall_badge_leaderboards' %}">Leaderboards</a></li>
                        {% if active_fundraiser %}
                            <li>
                                <a href="{% url 'fundraiser' active_fundraiser.slug %}">
                                    <span class="flex flex-row gap-2 items-center">
                                        Fundraiser
                                        <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-accent" viewBox="0 0 24 24" fill="currentColor"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
                                    </span>
                                </a>
                            </li>
                        {% endif %}
                    </ul>
                </details>
            </li>
            <!-- Earn -->
            <li>
                <details class="mega-menu-dropdown">
                    <summary>Earn</summary>
                    <ul class="mega-menu-content">
                        <li><a href="{% url 'badges_list' %}">Badges</a></li>
                        <li><a href="{% url 'milestones_list' %}">Milestones</a></li>
                    </ul>
                </details>
            </li>
            <!-- Guides -->
            <li>
                <details class="mega-menu-dropdown">
                    <summary>Guides</summary>
                    <ul class="mega-menu-content">
                        <li><a href="{% url 'guides_browse' %}">Guide Hub</a></li>
                        {% if user.is_authenticated and user.profile %}
                            <li><a href="{% url 'my_guides' %}">My Guides</a></li>
                        {% endif %}
                        <li>
                            <a href="{% url 'guides_list' %}" aria-label="PPTV Guides">
                                <span class="flex flex-row gap-2 items-center">
                                    PPTV Guides
                                    <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="var(--color-error)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <rect x="2" y="7" width="20" height="15" rx="2" ry="2"></rect>
                                        <polyline points="17 2 12 7 7 2"></polyline>
                                    </svg>
                                </span>
                            </a>
                        </li>
                    </ul>
                </details>
            </li>
            <!-- My Pursuit -->
            {% if user.is_authenticated and user.profile %}
            <li>
                <details class="mega-menu-dropdown">
                    <summary>My Pursuit</summary>
                    <ul class="mega-menu-content">
                        {% if user.is_staff %}
                        <li><a href="{% url 'dashboard' %}">My Dashboard (Staff Only)</a></li>
                        {% endif %}
                        <li><a href="{% url 'settings' %}">Customization</a></li>
                        <li><a href="{% url 'recap_index' %}">Monthly Recap</a></li>
                        <li><a href="{% url 'my_guides' %}">My Guides</a></li>
                        <li><a href="{% url 'my_challenges' %}">My Challenges</a></li>
                        <li><a href="{% url 'my_lists' %}">My Lists</a></li>
                        <li><a href="{% url 'profile_detail' user.profile.psn_username %}">My Profile</a></li>
                        <li><a href="{% url 'my_shareables' %}">My Shareables</a></li>
                        <li><a href="{% url 'trophy_case' user.profile.psn_username %}">Trophy Case</a></li>
                    </ul>
                </details>
            </li>
            {% endif %}
        </ul>
    </div>

    <!-- navbar-end: Recap icon, Search, Notifications, User dropdown -->
    <div class="navbar-end flex items-center gap-0 sm:gap-2 sm:mr-2">

        <!-- Monthly Recap Icon (auth only, hidden on mobile) -->
        {% if user.is_authenticated %}
        <a href="{% url 'recap_index' %}" class="btn btn-ghost btn-sm btn-circle hidden sm:flex" aria-label="Monthly Recap">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <title>Monthly Recap</title>
                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                <line x1="16" y1="2" x2="16" y2="6"></line>
                <line x1="8" y1="2" x2="8" y2="6"></line>
                <line x1="3" y1="10" x2="21" y2="10"></line>
            </svg>
        </a>
        {% endif %}

        <!-- Expandable Search (hidden on mobile) -->
        <div class="hidden sm:flex items-center">
            <button id="search-toggle-btn" class="btn btn-ghost btn-sm btn-circle" aria-label="Toggle search" aria-expanded="false">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <title>Search</title>
                    <circle cx="11" cy="11" r="8"></circle>
                    <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                </svg>
            </button>
            <div id="search-expandable" class="search-expandable">
                <form action="{% url 'search' %}" method="GET" class="join">
                    <select name="type" class="select select-sm select-primary join-item w-auto">
                        <option value="game">Game</option>
                        <option value="trophy">Trophy</option>
                        <option value="user">Profile</option>
                    </select>
                    <input id="search-input" type="text" name="query" placeholder="Search..." class="input input-primary input-sm join-item w-32 lg:w-40" />
                    <button type="submit" class="btn btn-sm btn-primary join-item">Go</button>
                </form>
            </div>
        </div>

        <!-- Notification Bell (auth only, hidden on mobile â€” mobile uses tab bar) -->
        {% if user.is_authenticated %}
        <div class="dropdown dropdown-end hidden lg:block" id="notification-dropdown">
            <button
                tabindex="0"
                class="btn btn-ghost btn-sm btn-circle relative"
                aria-label="Notifications"
                aria-haspopup="true"
                aria-expanded="false">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <title>Notifications</title>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
                </svg>
                <span id="notification-badge" class="absolute top-0 right-0 badge badge-error badge-sm hidden" aria-live="polite">0</span>
            </button>

            <div tabindex="0" class="dropdown-content z-[100] card card-compact w-80 sm:w-96 p-4 shadow-2xl bg-base-200 mt-3 border-2 border-base-300">
                <div class="flex items-center justify-between mb-3">
                    <h3 class="font-bold text-lg">Notifications</h3>
                    <button id="mark-all-read-btn" class="btn btn-xs btn-ghost" aria-label="Mark all as read">Mark all read</button>
                </div>

                <div id="notification-list" class="space-y-2 max-h-96 overflow-y-auto">
                    <div id="notification-loading" class="flex justify-center p-4">
                        <span class="loading loading-spinner loading-md"></span>
                    </div>
                    <div id="notification-empty" class="text-center p-4 hidden">
                        <p class="text-base-content/60">No notifications yet</p>
                    </div>
                </div>

                <a href="{% url 'notification_inbox' %}" class="btn btn-primary btn-sm mt-3 w-full">View All</a>
            </div>
        </div>
        {% endif %}

        <!-- User Avatar Dropdown -->
        {% if user.is_authenticated %}
            <div class="dropdown dropdown-end">
                <div class="indicator">
                    {% if not user.profile or not user.premium_tier %}
                        <span class="indicator-item border-2 border-base-300 rounded-full w-3 h-3 bg-error animate-pulse" aria-label="Attention required"></span>
                    {% endif %}
                    <div tabindex="0" role="button" class="btn btn-ghost btn-circle avatar" aria-label="User menu" aria-haspopup="true" aria-expanded="false">
                        <div class="w-15 rounded-full ring-2 ring-primary">
                            {% if user.profile %}
                                <img alt="Profile Picture" src="{{ user.profile.avatar_url }}" loading="lazy" decoding="async" />
                            {% else %}
                                <svg class="mx-auto my-1" xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <title>User avatar</title>
                                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                                    <circle cx="12" cy="7" r="4"></circle>
                                </svg>
                            {% endif %}
                        </div>
                    </div>
                </div>
                <ul tabindex="0" class="menu menu-sm dropdown-content mt-2 z-50 p-2 shadow-lg bg-base-100 border-2 border-base-200 min-w-48 w-fit">
                    <!-- Theme Toggle -->
                    <li>
                        <button id="theme-toggle-item" type="button" class="flex items-center gap-2 w-full">
                            <svg id="dropdown-theme-icon-sun" class="w-4 h-4 hidden" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="12" cy="12" r="5"/>
                                <path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/>
                            </svg>
                            <svg id="dropdown-theme-icon-moon" class="w-4 h-4 hidden" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                            </svg>
                            <span id="theme-toggle-label">Dark Mode</span>
                        </button>
                    </li>
                    <div class="divider my-0"></div>
                    <!-- Monthly Recap -->
                    <li>
                        <a href="{% url 'recap_index' %}" class="flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                                <line x1="16" y1="2" x2="16" y2="6"></line>
                                <line x1="8" y1="2" x2="8" y2="6"></line>
                                <line x1="3" y1="10" x2="21" y2="10"></line>
                            </svg>
                            Monthly Recap
                        </a>
                    </li>
                    <div class="divider my-0"></div>
                    {% if user.profile %}
                        {% if not user.premium_tier %}
                            <div class="indicator w-full">
                                <span class="indicator-item indicator-middle border-2 border-base-300 rounded-full w-3 h-3 bg-error animate-pulse"></span>
                                <li class="w-full"><a href="{% url 'subscribe' %}">PP Premium</a></li>
                            </div>
                        {% else %}
                            <li><a href="{% url 'subscription_management' %}">My Premium</a></li>
                        {% endif %}
                        <li><a href="{% url 'profile_detail' user.profile.psn_username %}">Profile</a></li>
                        <li><a href="{% url 'trophy_case' user.profile.psn_username %}">Trophy Case</a></li>
                    {% else %}
                        <div class="indicator w-full">
                            <span class="indicator-item indicator-middle border-2 border-base-300 rounded-full w-3 h-3 bg-error animate-pulse"></span>
                            <li class="w-full"><a href="{% url 'link_psn' %}">Link PSN</a></li>
                        </div>
                    {% endif %}
                    <div class="divider my-0"></div>
                    <li><a href="{% url 'settings' %}">Settings</a></li>
                    {% if user.is_staff %}
                        <li>
                            <a href="{% url 'comment_moderation' %}" class="flex items-center">
                                <span>Moderation</span>
                                {% if pending_reports_count > 0 %}
                                    <span class="text-error">({{ pending_reports_count }})</span>
                                {% endif %}
                            </a>
                        </li>
                        <li><a href="{% url 'fundraiser_admin' %}">Fundraiser</a></li>
                        {% if user.is_superuser %}
                            <li>
                                <a href="{% url 'game_family_management' %}" class="flex items-center">
                                    <span>Game Families</span>
                                    {% if pending_proposals_count > 0 %}
                                        <span class="text-error">({{ pending_proposals_count }})</span>
                                    {% endif %}
                                </a>
                            </li>
                        {% endif %}
                    {% endif %}
                    <div class="divider my-0"></div>
                    <li>
                        <form method="post" action="{% url 'logout' %}">
                            {% csrf_token %}
                            <button type="submit" class="w-full text-left">Logout</button>
                        </form>
                    </li>
                </ul>
            </div>
        {% else %}
            <div class="dropdown dropdown-end">
                <div tabindex="0" role="button" class="btn btn-ghost btn-circle avatar" aria-label="Login menu" aria-haspopup="true" aria-expanded="false">
                    <div class="w-15 rounded-full flex ring-2 ring-primary">
                        <svg class="mx-auto my-1" xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <title>Guest user</title>
                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                            <circle cx="12" cy="7" r="4"></circle>
                        </svg>
                    </div>
                </div>
                <ul tabindex="0" class="menu menu-sm dropdown-content mt-2 z-50 p-2 shadow-lg bg-base-100 border-2 border-base-200 w-fit">
                    <li><a href="{% url 'account_login' %}">Login</a></li>
                    <li><a href="{% url 'account_signup' %}">Register</a></li>
                </ul>
            </div>
        {% endif %}
    </div>
</nav>
