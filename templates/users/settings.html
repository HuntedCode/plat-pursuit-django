{% extends 'base.html' %}

{% block title %}User Settings{% endblock %}
{% block content %}
<div class="container mx-auto p-4 max-w-2xl">
    <div class="card bg-base-100 shadow-xl">
        <div class="card-body">
            <h2 class="text-3xl text-base-content font-semibold text-center italic">Settings</h2>
            <div class="divider divider-vertical m-0 p-0"></div>

            {% if messages %}
                {% for message in messages %}
                    <div class="alert {% if message.tags == 'error' %}alert-error{% elif message.tags == 'success' %}alert-success{% else %}alert-info{% endif %} mb-4" role="alert">
                        {{ message }}
                    </div>
                {% endfor %}
            {% endif %}

            <!-- User Settings Section -->
            <h3 class="text-2xl text-base-content font-semibold italic mb-2">User Settings</h3>
            <div class="flex flex-col border-4 border-base-300 shadow-lg shadow-neutral rounded-box p-4 w-7/8 mx-auto">
                <h3 class="text-xl font-semibold mb-2 italic">Regional Info</h3>
                <form method="post" class="space-y-4 w-7/8 mx-auto" id="user-settings-form">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="update_user">
                    <div class="form-control">
                        <label class="label" for="{{ user_form.user_timezone.id_for_label }}">Timezone</label>
                        {{ user_form.user_timezone }}
                        {% if user_form.user_timezone.errors %}
                            <div class="alert alert-error mt-1">{{ user_form.user_timezone.errors }}</div>
                        {% endif %}
                    </div>
                    <div class="form-control">
                        <label class="label" for="{{ user_form.default_region.id_for_label }}">Default Region</label>
                        {{ user_form.default_region }}
                        {% if user_form.default_region.errors %}
                            <div class="alert alert-error mt-1">{{ user_form.default_region.errors }}</div>
                        {% endif %}
                    </div>
                    <div class="form-control mb-4">
                        <label class="label" for="{{ user_form.use_24hr_clock.id_for_label }}">Use 24-Hour Clock Format</label>
                        <br />
                        {{ user_form.use_24hr_clock }}
                        <p class="text-center text-secondary font-bold pr-1 italic mt-1">
                            Example: 24-hour shows "23:00", 12-hour shows "11:00 PM"
                        </p>
                        {% if user_form.use_24hr_clock.errors %}
                            <div class="alert alert-error mt-1" role="alert">{{ user_form.use_24hr_clock.errors }}</div>
                        {% endif %}
                    </div>
                    <button type="submit" class="btn btn-primary w-full" id="user-settings-save-btn" disabled>Save User Settings</button>
                </form>

                <!-- Password Change Section -->
                <h3 class="text-xl font-semibold mt-6 mb-2 italic">Change Password</h3>
                <div class="flex flex-col items-center w-full">
                    <form method="post" class="space-y-4">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="change_password">
                        <div class="flex flex-col form-control items-center">
                            <label class="text-sm text-base-content/70 self-start" for="id_old_password">Old Password</label>
                            <input type="password" name="old_password" id="id_old_password" class="input input-primary w-full" placeholder="Old Password" autocomplete="current-password" required>
                        </div>
                        <div class="form-control">
                            <label class="text-base text-base-content/70 self-start" for="id_new_password1">New Password</label>
                            <input type="password" name="new_password1" id="id_new_password1" class="input input-accent w-full" placeholder="New Password" autocomplete="new-password" required>
                        </div>
                        <div class="form-control">
                            <label class="text-base text-base-content/70 self-start" for="id_new_password2">Confirm New Password</label>
                            <input type="password" name="new_password2" id="id_new_password2" class="input input-accent w-full" placeholder="Confirm New Password" autocomplete="new-password" required>
                        </div>
                        <button type="submit" class="btn btn-primary w-full">Change Password</button>
                    </form>
                </div>
            </div>

            <!-- Profile Settings Section (Conditional) -->
            {% if profile %}
                <div class="divider divider-vertical m-0 mt-2 p-0"></div>
                <h3 class="text-2xl text-base-content font-semibold italic mb-2">Premium Settings</h3>
                <div class="flex flex-col border-4 border-base-300 shadow-lg shadow-neutral rounded-box p-4 w-7/8 mx-auto">
                    {% if not profile.user_is_premium %}
                        <div class="alert alert-info mb-6" role="alert">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current shrink-0 w-6 h-6" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                            <span>Upgrade to premium to unlock these settings!</span>
                        </div>
                    {% endif %}

                    <!-- Premium Settings -->
                    {% if premium_form %}
                        <h3 class="text-xl font-semibold mb-2 italic">Profile Customization</h3>
                        <form method="post" class="w-7/8 mx-auto" id="premium-settings-form">
                            {% csrf_token %}
                            <input type="hidden" name="action" value="update_premium">
                            <div class="form-control mb-2">
                                <label class="label" for="{{ premium_form.selected_background.id_for_label }}">Profile Background</label>
                                {{ premium_form.selected_background }}
                                {% if premium_form.selected_background.errors %}
                                    <div class="alert alert-error mt-1">{{ premium_form.selected_background.errors }}</div>
                                {% endif %}
                            </div>
                            <p class="text-center text-accent font-bold pr-1 italic mb-4">Earn Plats to unlock more backgrounds!</p>

                            <!-- Site Theme Section -->
                            <div class="form-control mb-4">
                                <label class="label">
                                    <span class="label-text text-lg font-semibold">Site Theme</span>
                                </label>
                                <p class="text-sm text-base-content/70 mb-3">Select a gradient theme for your site-wide background. This appears on pages without a game background.</p>

                                <!-- Theme Grid Preview -->
                                <div class="grid grid-cols-4 sm:grid-cols-5 md:grid-cols-6 gap-2 mb-3 {% if not profile.user_is_premium %}opacity-50 pointer-events-none{% endif %}" id="theme-grid">
                                    {% for theme_key, theme_data in available_themes %}
                                    <button type="button"
                                            class="theme-preview-btn aspect-square rounded-lg border-2 transition-all hover:scale-105 cursor-pointer {% if profile.selected_theme == theme_key %}border-primary ring-2 ring-primary{% else %}border-base-300 hover:border-base-content/50{% endif %}"
                                            data-theme-key="{{ theme_key }}"
                                            data-theme-name="{{ theme_data.name }}"
                                            style="background: {{ theme_data.background_css }};"
                                            title="{{ theme_data.name }} - {{ theme_data.description }}">
                                        <span class="sr-only">{{ theme_data.name }}</span>
                                    </button>
                                    {% empty %}
                                    <p class="col-span-full text-center text-base-content/50">No themes available</p>
                                    {% endfor %}
                                </div>

                                <!-- Hidden select for form submission -->
                                <div class="hidden">
                                    {{ premium_form.selected_theme }}
                                </div>

                                <!-- Selected theme display -->
                                <div class="flex items-center gap-2 text-sm">
                                    <span class="text-base-content/70">Selected:</span>
                                    <span id="selected-theme-name" class="font-semibold">
                                        {% if profile.selected_theme %}
                                            {% for tk, td in available_themes %}{% if tk == profile.selected_theme %}{{ td.name }}{% endif %}{% endfor %}
                                        {% else %}
                                            None
                                        {% endif %}
                                    </span>
                                </div>

                                {% if premium_form.selected_theme.errors %}
                                    <div class="alert alert-error mt-1">{{ premium_form.selected_theme.errors }}</div>
                                {% endif %}
                            </div>

                            <!-- Live Preview -->
                            <div class="form-control mb-4">
                                <label class="label">
                                    <span class="label-text">Preview</span>
                                </label>
                                <div id="theme-preview-container" class="h-24 rounded-lg border border-base-300 flex items-center justify-center overflow-hidden"
                                     style="{% if profile.selected_theme %}{% for tk, td in available_themes %}{% if tk == profile.selected_theme %}background: {{ td.background_css }};{% endif %}{% endfor %}{% else %}background: linear-gradient(to bottom right, #2a2e34, #32363d, #2a2e34);{% endif %}">
                                    <span class="text-white font-bold text-lg drop-shadow-lg">{{ profile.display_psn_username }}</span>
                                </div>
                            </div>

                            <div class="divider"></div>

                            <div class="form-control mb-2">
                                <label class="label" for="{{ premium_form.title.id_for_label }}">Selected Title</label>
                                {{ premium_form.title }}
                                {% if premium_form.title.errors %}
                                    <div class="alert alert-error mt-1">{{ premium_form.title.errors }}</div>
                                {% endif %}
                            </div>
                            <p class="text-center text-accent font-bold pr-1 italic mb-4">Earn Badges to unlock more titles!</p>

                            <button type="submit" class="btn btn-secondary w-full" id="premium-settings-save-btn" {% if not profile.user_is_premium %}disabled{% endif %}>Save Premium Settings</button>
                        </form>
                    {% endif %}
                </div>
                    
                <div class="divider divider-vertical m-0 mt-2 p-0"></div>
                <h3 class="text-2xl text-base-content font-semibold italic mb-2">Profile Settings</h3>
                <div class="flex flex-col border-4 border-base-300 shadow-lg shadow-neutral rounded-box p-4 w-7/8 mx-auto">
                    <div class="flex flex-row justify-center">
                        <div class="avatar mr-4">
                            <div class="w-8 rounded-full ring-2 ring-primary">
                                <img src="{{ profile.avatar_url|default:'/static/default-avatar.png' }}" alt="{{ profile.display_psn_username }}'s avatar" loading="lazy" decoding="async" />
                            </div>
                        </div>
                        <div class="flex flex-row items-center gap-3">
                            <span id="sync-user" class="text-xs sm:text-base font-bold">{{ profile.display_psn_username }}</span>
                            <div class="divider divider-horizontal m-0 p-0"></div>
                            <span class="text-xs sm:text-base font-bold">Last Sync: {{ profile.last_synced|date }}</span>
                            
                        </div>
                    </div>
                    
                    <label for="unlink-modal" class="btn btn-error w-full mt-4">Unlink PSN Profile</label>

                    <div class="divider divider-vertical w-full"></div>

                    <h3 class="text-xl font-semibold mb-2 italic">Hide Games From Profile</h3>
                    <form method="post" class="w-7/8 mx-auto" id="profile-settings-form">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="update_profile">
                        <div class="form-control mb-2" disabled>
                            <label class="label" for="{{ profile_form.hide_hiddens.id_for_label }}">Hide Hidden/Deleted Games</label>
                            <br />
                            {{ profile_form.hide_hiddens }}
                            {% if profile_form.hide_hiddens.errors %}
                                <div class="alert alert-error mt-1">{{ profile_form.hide_hiddens.errors }}</div>
                            {% endif %}
                        </div>
                        <p class="text-center text-secondary font-bold pr-1 italic mb-4">Set to true to hide hidden/deleted games from your profile.</p>

                        <div class="form-control mb-2" disabled>
                            <label class="label" for="{{ profile_form.hide_zeros.id_for_label }}">Hide Zero Progress Games</label>
                            <br />
                            {{ profile_form.hide_zeros }}
                            {% if profile_form.hide_zeros.errors %}
                                <div class="alert alert-error mt-1">{{ profile_form.hide_zeros.errors }}</div>
                            {% endif %}
                        </div>
                        <p class="text-center text-secondary font-bold pr-1 italic mb-4">Set to true to hide games you haven't earned a trophy in yet.</p>

                        <button type="submit" class="btn btn-primary w-full" id="profile-settings-save-btn" disabled>Save Profile Settings</button>
                    </form>
                    
                    <input type="checkbox" id="unlink-modal" class="modal-toggle" />
                    <div class="modal backdrop-blur-lg" role="dialog" aria-modal="true" aria-labelledby="unlink-modal-title">
                        <div class="modal-box border-4 border-error shadow-lg shadow-error">
                            <h3 id="unlink-modal-title" class="text-xl text-base-content font-bold italic">Confirm Unlink</h3>
                            <p class="py-4">Are you sure? This will unlink your PSN profile and may restrict site features. You can relink later.</p>
                            <div class="modal-action">
                                <form method="post">
                                    {% csrf_token %}
                                    <input type="hidden" name="action" value="unlink_profile">
                                    <button type="submit" class="btn btn-error">Yes, Unlink</button>
                                </form>
                                <label for="unlink-modal" class="btn">Cancel</label>
                            </div>
                        </div>
                    </div>
                </div>
            {% else %}
                <p class="mt-6">No PSN profile linked. <a href="{% url 'link_psn' %}" class="link link-primary">Link now</a>.</p>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block js_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // ==========================================
    // Theme Grid Handler
    // ==========================================
    const themeGrid = document.getElementById('theme-grid');
    const themeSelect = document.getElementById('selected-theme-select');
    const previewContainer = document.getElementById('theme-preview-container');
    const selectedThemeName = document.getElementById('selected-theme-name');

    if (themeGrid && themeSelect) {
        // Handle theme button clicks
        themeGrid.addEventListener('click', function(e) {
            const btn = e.target.closest('.theme-preview-btn');
            if (!btn) return;

            const themeKey = btn.dataset.themeKey;
            const themeName = btn.dataset.themeName;

            // Update visual selection
            themeGrid.querySelectorAll('.theme-preview-btn').forEach(b => {
                b.classList.remove('border-primary', 'ring-2', 'ring-primary');
                b.classList.add('border-base-300');
            });
            btn.classList.remove('border-base-300');
            btn.classList.add('border-primary', 'ring-2', 'ring-primary');

            // Update hidden select and trigger change event for save button activation
            themeSelect.value = themeKey;
            themeSelect.dispatchEvent(new Event('change', { bubbles: true }));

            // Update preview box
            if (previewContainer) {
                previewContainer.style.background = btn.style.background;
            }

            // Update selected name display
            if (selectedThemeName) {
                selectedThemeName.textContent = themeName || 'Default';
            }

            // Live preview: Update the actual page background
            const bgStyle = btn.style.background;
            if (bgStyle) {
                document.body.style.background = bgStyle;
                document.body.style.backgroundAttachment = 'fixed';
            }
        });
    }

    // ==========================================
    // Unsaved Changes Warning & Save Button Activation
    // ==========================================
    // Track these forms (password form intentionally excluded)
    const isPremiumUser = {% if profile and profile.user_is_premium %}true{% else %}false{% endif %};
    const trackedForms = [
        { formId: 'user-settings-form', saveBtn: 'user-settings-save-btn', canSave: true },
        { formId: 'premium-settings-form', saveBtn: 'premium-settings-save-btn', canSave: isPremiumUser },
        { formId: 'profile-settings-form', saveBtn: 'profile-settings-save-btn', canSave: true }
    ];
    const originalValues = {};

    function captureOriginalState() {
        trackedForms.forEach(({ formId }) => {
            const form = document.getElementById(formId);
            if (!form) return;

            form.querySelectorAll('input, select, textarea').forEach(el => {
                // Skip action hidden inputs and password fields
                if (el.type === 'hidden' && el.name === 'action') return;
                if (el.type === 'hidden' && el.name === 'csrfmiddlewaretoken') return;
                if (el.type === 'password') return;

                const key = `${formId}:${el.name || el.id}`;
                if (el.type === 'checkbox') {
                    originalValues[key] = el.checked;
                } else {
                    originalValues[key] = el.value;
                }
            });
        });
    }

    function formHasChanges(formId) {
        const form = document.getElementById(formId);
        if (!form) return false;

        const elements = form.querySelectorAll('input, select, textarea');
        for (const el of elements) {
            // Skip action hidden inputs and password fields
            if (el.type === 'hidden' && el.name === 'action') continue;
            if (el.type === 'hidden' && el.name === 'csrfmiddlewaretoken') continue;
            if (el.type === 'password') continue;

            const key = `${formId}:${el.name || el.id}`;
            const currentValue = el.type === 'checkbox' ? el.checked : el.value;

            if (originalValues[key] !== currentValue) {
                return true;
            }
        }
        return false;
    }

    function hasUnsavedChanges() {
        return trackedForms.some(({ formId }) => formHasChanges(formId));
    }

    function updateSaveButtons() {
        trackedForms.forEach(({ formId, saveBtn, canSave }) => {
            const btn = document.getElementById(saveBtn);
            if (!btn) return;

            // Only enable if form has changes AND user has permission
            const hasChanges = formHasChanges(formId);
            btn.disabled = !hasChanges || !canSave;
        });
    }

    // Attach change listeners to all tracked form elements
    function setupChangeListeners() {
        trackedForms.forEach(({ formId }) => {
            const form = document.getElementById(formId);
            if (!form) return;

            form.querySelectorAll('input, select, textarea').forEach(el => {
                // Skip action hidden inputs
                if (el.type === 'hidden' && el.name === 'action') return;
                if (el.type === 'hidden' && el.name === 'csrfmiddlewaretoken') return;

                el.addEventListener('change', updateSaveButtons);
                el.addEventListener('input', updateSaveButtons);
            });
        });
    }

    // Initialize unsaved changes tracking
    captureOriginalState();
    setupChangeListeners();
    updateSaveButtons();  // Set initial button states

    PlatPursuit.UnsavedChangesManager.init({
        hasUnsavedChanges: hasUnsavedChanges,
        showSaveButton: false  // POST forms, no API save
    });
});
</script>
{% endblock %}